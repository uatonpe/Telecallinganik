<!DOCTYPE html>
<html lang="mr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>‡§ì‡§°‡•Ä ‡§™‡§∞‡§´‡•â‡§∞‡•ç‡§Æ‡§®‡•ç‡§∏ ‡§°‡•Ö‡§∂‡§¨‡•ã‡§∞‡•ç‡§°</title>
<script src="https://www.gstatic.com/charts/loader.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&family=Noto+Sans+Devanagari:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
    :root {
        --primary-bg: #f0f2f5; --card-bg: #ffffff; --header-bg: #0d47a1; --primary-text: #212529;
        --secondary-text: #6c757d; --accent-blue: #007bff; --accent-green: #28a745;
        --accent-orange: #fd7e14; --accent-red: #dc3545; --accent-purple: #6f42c1; --accent-teal: #20c997; --shadow: 0 4px 12px rgba(0, 0, 0, 0.07);
    }
    body { font-family: 'Poppins', 'Noto Sans Devanagari', sans-serif; background-color: var(--primary-bg); margin: 0; color: var(--primary-text); }
    .header { background: var(--header-bg); padding: 18px 30px; color: white; display: flex; align-items: center; justify-content: space-between; box-shadow: 0 2px 4px rgba(0,0,0,0.2); flex-wrap: wrap; gap: 15px;}
    .header h1 { margin: 0; font-size: 24px; font-weight: 600; }
    .filters { display: flex; align-items: center; gap: 20px; flex-wrap: wrap; }
    .filter-item { display: flex; align-items: center; gap: 8px; }
    .filters label { font-size: 14px; font-weight: 500; }
    .filters input[type="date"], .filters select {
        padding: 8px 12px; border-radius: 6px; border: 1px solid #ffffff55;
        background: #ffffff22; color: white; font-family: inherit; min-width: 150px;
    }
    .filters select option { color: black; background: white; }
    .main-container { padding: 25px; max-width: 1800px; margin: auto; }
    .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 25px; margin-bottom: 25px; }
    .kpi-card { display: flex; align-items: center; gap: 20px; background: var(--card-bg); padding: 25px; border-radius: 12px; box-shadow: var(--shadow); transition: transform 0.3s, box-shadow 0.3s; cursor: pointer; }
    .kpi-card:hover { transform: translateY(-5px); box-shadow: 0 8px 16px rgba(0,0,0,0.1); }
    .kpi-icon { width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
    .kpi-icon svg { width: 24px; height: 24px; }
    .kpi-content .value { font-size: 32px; font-weight: 700; color: var(--primary-text); }
    .kpi-content .label { font-size: 15px; color: var(--secondary-text); }

    /* KPI Icon Colors */
    #kpiCalls .kpi-icon { background: #e6f2ff; color: var(--accent-blue); }
    #kpiPtp .kpi-icon { background: #eaf7ea; color: var(--accent-green); }
    #kpiPaidToStaff .kpi-icon { background: #e9f9f5; color: var(--accent-teal); }
    #kpiInterestIssue .kpi-icon { background: #fff0e0; color: #ff8c00; }
    #kpiWrongNo .kpi-icon { background: #fff4e6; color: var(--accent-orange); }
    #kpiNotPicked .kpi-icon { background: #fde8e8; color: var(--accent-red); }

    .dashboard-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 25px; }
    @media (max-width: 1000px) { .dashboard-grid { grid-template-columns: 1fr; } }
    .chart-card { background: var(--card-bg); padding: 25px; border-radius: 12px; box-shadow: var(--shadow); }
    .chart-card h3 { margin-top: 0; font-size: 18px; font-weight: 600; color: var(--header-bg); border-bottom: 1px solid #eee; padding-bottom: 15px; margin-bottom: 20px; }
    .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); }
    .modal-content { background-color: #fefefe; margin: 8% auto; padding: 20px; border-radius: 12px; width: 90%; max-width: 900px; box-shadow: 0 4px 8px 0 rgba(0,0,0,0.2); }
    .modal-header { padding-bottom: 10px; border-bottom: 1px solid #ddd; }
    .modal-header h2 { margin: 0; color: var(--header-bg); }
    .close { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
    #customerListTable { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 14px; }
    #customerListTable th, #customerListTable td { border: 1px solid #ddd; padding: 10px; text-align: left; }
    #customerListTable th { background-color: #f2f2f2; font-weight: 600; }
</style>
</head>
<body>
<header class="header">
    <h1>üìä ‡§ì‡§°‡•Ä ‡§™‡§∞‡§´‡•â‡§∞‡•ç‡§Æ‡§®‡•ç‡§∏ ‡§°‡•Ö‡§∂‡§¨‡•ã‡§∞‡•ç‡§°</h1>
    <div class="filters">
        <div class="filter-item">
            <label for="dashboardDate">‡§§‡§æ‡§∞‡•Ä‡§ñ:</label>
            <input type="date" id="dashboardDate">
        </div>
        <div class="filter-item">
             <label for="unitFilter">‡§Ø‡•Å‡§®‡§ø‡§ü:</label>
             <select id="unitFilter">
                <option value="All">‡§∏‡§∞‡•ç‡§µ ‡§Ø‡•Å‡§®‡§ø‡§ü‡•ç‡§∏</option>
             </select>
        </div>
        <div class="filter-item">
             <label for="callerFilter">‡§ï‡•â‡§≤‡§∞ (CA):</label>
             <select id="callerFilter">
                <option value="All">‡§∏‡§∞‡•ç‡§µ ‡§ï‡•â‡§≤‡§∞</option>
             </select>
        </div>
    </div>
</header>
<div class="main-container">
    <div class="kpi-grid">
        <div class="kpi-card" id="kpiCalls" onclick="showKpiDetails('total')"><div class="kpi-icon"><svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 16 16"><path d="M3.654 1.328a.678.678 0 0 0-1.015-.063L1.605 2.3c-.483.484-.661 1.169-.45 1.77a17.6 17.6 0 0 0 4.168 6.608 17.6 17.6 0 0 0 6.608 4.168c.601.211 1.286.033 1.77-.45l1.034-1.034a.678.678 0 0 0-.063-1.015l-2.307-1.794a.68.68 0 0 0-.58-.122l-2.19.547a1.75 1.75 0 0 1-1.657-.459L5.482 8.062a1.75 1.75 0 0 1-.46-1.657l.548-2.19a.68.68 0 0 0-.122-.58z"/></svg></div><div class="kpi-content"><div class="value" id="valTotalCalls">0</div><div class="label">‡§è‡§ï‡•Ç‡§£ ‡§ï‡•â‡§≤‡•ç‡§∏</div></div></div>
        <div class="kpi-card" id="kpiPtp" onclick="showKpiDetails('ptp')"><div class="kpi-icon"><svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 16 16"><path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0m-3.97-3.03a.75.75 0 0 0-1.08.022L7.477 9.417 5.384 7.323a.75.75 0 0 0-1.06 1.06L6.97 11.03a.75.75 0 0 0 1.079-.02l3.992-4.99a.75.75 0 0 0-.01-1.05z"/></svg></div><div class="kpi-content"><div class="value" id="valPtp">0</div><div class="label">‡§™‡•á‡§Æ‡•á‡§Ç‡§ü‡§ö‡•Ä ‡§§‡§æ‡§∞‡•Ä‡§ñ ‡§®‡§ø‡§∂‡•ç‡§ö‡§ø‡§§</div></div></div>
        <div class="kpi-card" id="kpiPaidToStaff" onclick="showKpiDetails('paidToStaff')"><div class="kpi-icon"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M1 3a1 1 0 0 1 1-1h12a1 1 0 0 1 1 1zm12-1a2 2 0 0 0-2-2H4a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2zM15 5a1 1 0 0 1-1 1H2a1 1 0 0 1-1-1V4a1 1 0 0 1 1-1h12a1 1 0 0 1 1 1zM8 8a1 1 0 0 1 1-1h6a1 1 0 0 1 1 1v6a1 1 0 0 1-1 1H9a1 1 0 0 1-1-1z"/></svg></div><div class="kpi-content"><div class="value" id="valPaidToStaff">0</div><div class="label">‡§π‡§™‡•ç‡§§‡§æ ‡§∏‡•ç‡§ü‡§æ‡§´‡§ï‡§°‡•á ‡§≠‡§∞‡§≤‡§æ</div></div></div>
        <div class="kpi-card" id="kpiInterestIssue" onclick="showKpiDetails('interestIssue')"><div class="kpi-icon"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M8.982 1.566a1.13 1.13 0 0 0-1.96 0L.165 13.233c-.457.778.091 1.767.98 1.767h13.713c.889 0 1.438-.99.98-1.767zM8 5c.535 0 .954.462.9.995l-.35 3.507a.552.552 0 0 1-1.1 0L7.1 5.995A.905.905 0 0 1 8 5m.002 6a1 1 0 1 1 0 2 1 1 0 0 1 0-2"/></svg></div><div class="kpi-content"><div class="value" id="valInterestIssue">0</div><div class="label">‡§µ‡•ç‡§Ø‡§æ‡§ú‡§æ‡§ö‡§æ ‡§á‡§∂‡•ç‡§Ø‡•Ç</div></div></div>
        <div class="kpi-card" id="kpiWrongNo" onclick="showKpiDetails('wrongNo')"><div class="kpi-icon"><svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 16 16"><path d="M11.95.706a.5.5 0 0 1 .547.098l.53.53a.5.5 0 0 1 0 .708L8.835 6.22a.5.5 0 0 1-.707 0l-.53-.53a.5.5 0 0 1 0-.707l4.723-4.184a.5.5 0 0 1 .547-.098zm-2.43 2.585a.5.5 0 0 0-.612.334L8.25 6.342a.5.5 0 0 0 .612.334l.278-.64a.5.5 0 0 0-.333-.612l-.64-.278zm2.59.085a.5.5 0 0 0-.293.425l-.133.728a.5.5 0 0 0 .425.293l.728.133a.5.5 0 0 0 .293-.425l.133-.728a.5.5 0 0 0-.425-.293l-.728-.133zM3.363 7.043a.5.5 0 0 1-.547.098L.53 3.422a.5.5 0 0 1 0-.707L4.723.43a.5.5 0 0 1 .547.098l2.286 3.738a.5.5 0 0 1 0 .707L3.363 7.043zm1.187-1.187a.5.5 0 1 0-.707-.707.5.5 0 0 0 .707.707zm-.707-1.414a.5.5 0 1 0-.707.707.5.5 0 0 0 .707-.707z"/></svg></div><div class="kpi-content"><div class="value" id="valWrongNo">0</div><div class="label">‡§ö‡•Å‡§ï‡•Ä‡§ö‡§æ ‡§Æ‡•ã‡§¨‡§æ‡§à‡§≤ ‡§®‡§Ç‡§¨‡§∞</div></div></div>
        <div class="kpi-card" id="kpiNotPicked" onclick="showKpiDetails('notPicked')"><div class="kpi-icon"><svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 16 16"><path d="M11 1a1 1 0 0 1 1 1v12a1 1 0 0 1-1 1H5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1zM5 0a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2V2a2 2 0 0 0-2-2z"/><path d="M8 14a1 1 0 1 0 0-2 1 1 0 0 0 0 2"/></svg></div><div class="kpi-content"><div class="value" id="valNotPicked">0</div><div class="label">‡§ï‡•â‡§≤ ‡§ò‡•á‡§§‡§≤‡§æ ‡§®‡§æ‡§π‡•Ä</div></div></div>
    </div>
    <div class="dashboard-grid">
        <div class="chart-card"><h3>üìä ‡§Ü‡§ú‡§ö‡•ç‡§Ø‡§æ ‡§ï‡•â‡§≤‡§ö‡•á ‡§™‡•ç‡§∞‡§§‡§ø‡§∏‡§æ‡§¶ ‡§µ‡§∞‡•ç‡§ó‡•Ä‡§ï‡§∞‡§£</h3><div id="statusPieChart" style="width: 100%; height: 400px;"></div></div>
        <div class="chart-card"><h3>üìà ‡§ï‡•â‡§≤‡§∞‡§®‡•Å‡§∏‡§æ‡§∞ ‡§™‡•ç‡§∞‡§§‡§ø‡§∏‡§æ‡§¶‡§æ‡§Ç‡§ö‡•á ‡§µ‡§∞‡•ç‡§ó‡•Ä‡§ï‡§∞‡§£</h3><div id="callerPerformanceChart" style="width: 100%; height: 400px;"></div></div>
    </div>
</div>
<div id="customerModal" class="modal">
    <div class="modal-content">
        <div class="modal-header"><span class="close" onclick="closeModal()">&times;</span><h2 id="modalTitle">‡§ó‡•ç‡§∞‡§æ‡§π‡§ï‡§æ‡§Ç‡§ö‡•Ä ‡§Ø‡§æ‡§¶‡•Ä</h2></div>
        <div style="max-height: 450px; overflow-y: auto;">
            <table id="customerListTable">
                <thead><tr><th>‡§≤‡•ã‡§® ‡§®‡§Ç‡§¨‡§∞</th><th>‡§ó‡•ç‡§∞‡§æ‡§π‡§ï</th><th>‡§Æ‡•ã‡§¨‡§æ‡§à‡§≤ ‡§®‡§Ç‡§¨‡§∞</th><th>‡§∏‡•ç‡§•‡§ø‡§§‡•Ä / ‡§§‡§™‡§∂‡•Ä‡§≤</th></tr></thead>
                <tbody id="customerListBody"></tbody>
            </table>
        </div>
    </div>
</div>

<script>
    const API_KEY = "AIzaSyCib9D8dkRRV7MyGDfTcCqaubl19RnCdhQ"; // <<<<<<<<<<<<< ‡§§‡•Å‡§Æ‡§ö‡•Ä API Key ‡§Ø‡•á‡§•‡•á ‡§ü‡§æ‡§ï‡§æ
    const SPREADSHEET_ID = "1CW1mC206dts-42HOM81X6xVwhtwz70gjD9kyzT0Pwc8"; // <<<<<< ‡§§‡•Å‡§Æ‡§ö‡§æ Spreadsheet ID ‡§Ø‡•á‡§•‡•á ‡§ü‡§æ‡§ï‡§æ
    
    const LOG_SHEET_NAME = "CallLogs";
    const MASTER_DATA_SHEET_NAME = "MasterData";

    let allCallData = [];
    let dailyFilteredData = [];

    document.addEventListener('DOMContentLoaded', () => {
        const today = new Date().toISOString().slice(0, 10);
        document.getElementById('dashboardDate').value = today;
        document.getElementById('dashboardDate').addEventListener('change', updateDashboard);
        document.getElementById('unitFilter').addEventListener('change', updateDashboard);
        document.getElementById('callerFilter').addEventListener('change', updateDashboard);
        google.charts.load('current', {'packages':['corechart']});
        google.charts.setOnLoadCallback(fetchData);
    });

    async function fetchData() {
        try {
            // **[CHANGE 1]** ‡§¶‡•ã‡§®‡•ç‡§π‡•Ä ‡§∂‡•Ä‡§ü‡•ç‡§∏‡§Æ‡§ß‡•Ä‡§≤ ‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï ‡§∏‡§∞‡•ç‡§µ ‡§ï‡•â‡§≤‡§Æ ‡§Ü‡§£‡§£‡•ç‡§Ø‡§æ‡§∏‡§æ‡§†‡•Ä ‡§∞‡•á‡§Ç‡§ú ‡§µ‡§æ‡§¢‡§µ‡§≤‡•Ä.
            const ranges = [`${LOG_SHEET_NAME}!A:I`, `${MASTER_DATA_SHEET_NAME}!A:J`]; 
            const response = await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values:batchGet?ranges=${ranges.join('&ranges=')}&key=${API_KEY}`);
            if (!response.ok) throw new Error(`Google Sheets API error: ${response.statusText}`);
            const data = await response.json();

            const callLogRows = data.valueRanges[0].values || [];
            const masterDataRows = data.valueRanges[1].values || [];
            
            if (callLogRows.length < 2 || masterDataRows.length < 2) {
                allCallData = [];
                updateDashboard();
                return;
            }

            const masterHeaders = masterDataRows.shift();
            const loanNoIndex = masterHeaders.indexOf("‡§≤‡•ã‡§® ‡§®‡§Ç‡§¨‡§∞");
            const unitIndex = masterHeaders.indexOf("‡§Ø‡•Å‡§®‡§ø‡§ü ‡§®‡§æ‡§Ç‡§µ");
            // **[CHANGE 2]** ‡§Æ‡•ã‡§¨‡§æ‡§à‡§≤ ‡§®‡§Ç‡§¨‡§∞‡§ö‡§æ ‡§ï‡•â‡§≤‡§Æ ‡§á‡§Ç‡§°‡•á‡§ï‡•ç‡§∏ ‡§•‡•á‡§ü ‡§¶‡§ø‡§≤‡§æ (J = 9, ‡§ï‡§æ‡§∞‡§£ ‡§á‡§Ç‡§°‡•á‡§ï‡•ç‡§∏ 0 ‡§™‡§æ‡§∏‡•Ç‡§® ‡§∏‡•Å‡§∞‡•Ç ‡§π‡•ã‡§§‡•ã).
            // ‡§§‡•Å‡§Æ‡•ç‡§π‡•Ä ‡§®‡§æ‡§µ‡§æ‡§µ‡§∞‡•Ç‡§® ‡§∂‡•ã‡§ß‡•Ç ‡§∂‡§ï‡§§‡§æ, ‡§™‡§£ ‡§•‡•á‡§ü ‡§á‡§Ç‡§°‡•á‡§ï‡•ç‡§∏ ‡§¶‡•á‡§£‡•á ‡§Ö‡§ß‡§ø‡§ï ‡§ñ‡§æ‡§§‡•ç‡§∞‡•Ä‡§ö‡•á ‡§Ü‡§π‡•á.
            const mobileIndex = 9; // Column J

            const loanDetailsLookup = new Map();
            const uniqueUnits = new Set();
            masterDataRows.forEach(row => {
                const loanNo = row[loanNoIndex];
                if (loanNo) {
                    loanDetailsLookup.set(String(loanNo), { 
                        unit: row[unitIndex] || '‡§Ö‡§ú‡•ç‡§û‡§æ‡§§', 
                        mobile: row[mobileIndex] || '-' 
                    });
                    if(row[unitIndex]) uniqueUnits.add(row[unitIndex]);
                }
            });
            populateUnitFilter(uniqueUnits);

            const callLogHeaders = callLogRows.shift();
            const uniqueCallers = new Set();
            allCallData = callLogRows.map(row => {
                const loanNo = row[3]; // Column D
                const details = loanDetailsLookup.get(String(loanNo)) || { unit: '‡§Ö‡§ú‡•ç‡§û‡§æ‡§§', mobile: '-' };
                const callerName = row[2]; // Column C
                if(callerName) uniqueCallers.add(callerName);

                return {
                    date: row[1],           // Column B
                    caller: callerName,
                    loanNo: loanNo,
                    customerName: row[4],   // Column E
                    status: row[5],         // Column F
                    rawDetails: row[6],     // Column G
                    amountPaidTo: row[7],   // **[NEW]** Column H
                    paymentDate: row[8],    // **[NEW]** Column I
                    unit: details.unit,
                    mobileNo: details.mobile
                };
            });
            
            populateCallerFilter(uniqueCallers);
            updateDashboard();
        } catch (error) {
            console.error("Error fetching data:", error);
            alert("‡§°‡•á‡§ü‡§æ ‡§≤‡•ã‡§° ‡§ï‡§∞‡§£‡•ç‡§Ø‡§æ‡§§ ‡§Ö‡§Ø‡§∂‡§∏‡•ç‡§µ‡•Ä. ‡§§‡•Å‡§Æ‡§ö‡•Ä API Key, Sheet ID ‡§Ü‡§£‡§ø ‡§ï‡•â‡§≤‡§Æ‡§ö‡•Ä ‡§®‡§æ‡§µ‡•á ‡§§‡§™‡§æ‡§∏‡§æ.");
        }
    }

    function populateUnitFilter(units) {
        const unitFilter = document.getElementById('unitFilter');
        unitFilter.innerHTML = '<option value="All">‡§∏‡§∞‡•ç‡§µ ‡§Ø‡•Å‡§®‡§ø‡§ü‡•ç‡§∏</option>';
        Array.from(units).sort().forEach(unit => {
            const option = document.createElement('option');
            option.value = unit;
            option.textContent = unit;
            unitFilter.appendChild(option);
        });
    }
    
    function populateCallerFilter(callers) {
        const callerFilter = document.getElementById('callerFilter');
        callerFilter.innerHTML = '<option value="All">‡§∏‡§∞‡•ç‡§µ ‡§ï‡•â‡§≤‡§∞</option>';
        Array.from(callers).sort().forEach(caller => {
            const option = document.createElement('option');
            option.value = caller;
            option.textContent = caller;
            callerFilter.appendChild(option);
        });
    }

    function updateDashboard() {
        const selectedDate = document.getElementById('dashboardDate').value;
        const selectedUnit = document.getElementById('unitFilter').value;
        const selectedCaller = document.getElementById('callerFilter').value;
        
        dailyFilteredData = allCallData.filter(row => {
            const dateMatch = row.date === selectedDate;
            const unitMatch = (selectedUnit === 'All' || row.unit === selectedUnit);
            const callerMatch = (selectedCaller === 'All' || row.caller === selectedCaller);
            return dateMatch && unitMatch && callerMatch;
        });
        
        const totalCalls = dailyFilteredData.length;
        const ptpCount = dailyFilteredData.filter(r => r.status === '‡§™‡•á‡§Æ‡•á‡§Ç‡§ü‡§ö‡•Ä ‡§§‡§æ‡§∞‡•Ä‡§ñ ‡§®‡§ø‡§∂‡•ç‡§ö‡§ø‡§§').length;
        const wrongNoCount = dailyFilteredData.filter(r => r.status === '‡§ö‡•Å‡§ï‡•Ä‡§ö‡§æ ‡§Æ‡•ã‡§¨‡§æ‡§à‡§≤ ‡§®‡§Ç‡§¨‡§∞').length;
        const notPickedCount = dailyFilteredData.filter(r => r.status === '‡§ï‡•â‡§≤ ‡§ò‡•á‡§§‡§≤‡§æ ‡§®‡§æ‡§π‡•Ä').length;
        const paidToStaffCount = dailyFilteredData.filter(r => r.status === '‡§π‡§™‡•ç‡§§‡§æ ‡§∏‡•ç‡§ü‡§æ‡§´‡§ï‡§°‡•á ‡§≠‡§∞‡§≤‡•á‡§≤‡§æ ‡§Ü‡§π‡•á').length;
        const interestIssueCount = dailyFilteredData.filter(r => r.status === '‡§µ‡•ç‡§Ø‡§æ‡§ú‡§æ‡§ö‡§æ ‡§á‡§∂‡•ç‡§Ø‡•Ç').length;

        document.getElementById('valTotalCalls').innerText = totalCalls;
        document.getElementById('valPtp').innerText = ptpCount;
        document.getElementById('valWrongNo').innerText = wrongNoCount;
        document.getElementById('valNotPicked').innerText = notPickedCount;
        document.getElementById('valPaidToStaff').innerText = paidToStaffCount;
        document.getElementById('valInterestIssue').innerText = interestIssueCount;

        drawStatusPieChart(dailyFilteredData);
        drawCallerPerformanceChart(dailyFilteredData);
    }
    
    function drawStatusPieChart(data) {
        const statusCounts = data.reduce((acc, row) => {
            acc[row.status] = (acc[row.status] || 0) + 1;
            return acc;
        }, {});
        const chartData = [['‡§∏‡•ç‡§ü‡•á‡§ü‡§∏', '‡§∏‡§Ç‡§ñ‡•ç‡§Ø‡§æ'], ...Object.entries(statusCounts)];
        const options = { pieHole: 0.4, fontName: 'Noto Sans Devanagari', legend: { position: 'bottom' }, chartArea:{left:15,top:20,width:'90%',height:'75%'} };
        const chart = new google.visualization.PieChart(document.getElementById('statusPieChart'));
        
        google.visualization.events.addListener(chart, 'select', () => {
            const selection = chart.getSelection();
            if (selection.length > 0) {
                const selectedStatus = chartData[selection[0].row + 1][0];
                const customers = data.filter(row => row.status === selectedStatus);
                displayCustomerModal(`'${selectedStatus}' ‡§Ö‡§∏‡§≤‡•á‡§≤‡•á ‡§ó‡•ç‡§∞‡§æ‡§π‡§ï`, customers);
            }
        });
        chart.draw(google.visualization.arrayToDataTable(chartData.length > 1 ? chartData : [['Data', 0]]), options);
    }
    
    function drawCallerPerformanceChart(data) {
        if (data.length === 0) {
            document.getElementById('callerPerformanceChart').innerHTML = '<p style="text-align:center;color:grey;margin-top:50px;">‡§Ø‡§æ ‡§§‡§æ‡§∞‡§ñ‡•á‡§∏‡§æ‡§†‡•Ä ‡§ï‡•ã‡§£‡§§‡§æ‡§π‡•Ä ‡§°‡•á‡§ü‡§æ ‡§â‡§™‡§≤‡§¨‡•ç‡§ß ‡§®‡§æ‡§π‡•Ä.</p>';
            return;
        }
        const callerStatus = {};
        const allStatuses = new Set(data.map(r => r.status));
        data.forEach(row => {
            if (!callerStatus[row.caller]) callerStatus[row.caller] = {};
            callerStatus[row.caller][row.status] = (callerStatus[row.caller][row.status] || 0) + 1;
        });
        const sortedStatuses = Array.from(allStatuses).sort();
        const chartData = [['‡§ï‡•â‡§≤‡§∞', ...sortedStatuses]];
        for (const caller in callerStatus) {
            const row = [caller];
            sortedStatuses.forEach(status => { row.push(callerStatus[caller][status] || 0); });
            chartData.push(row);
        }
        const options = { isStacked: true, fontName: 'Noto Sans Devanagari', legend: { position: 'top', maxLines: 3 }, chartArea: {width: '70%', height: '75%'}, hAxis: { title: '‡§è‡§ï‡•Ç‡§£ ‡§ï‡•â‡§≤‡•ç‡§∏', minValue: 0 }, vAxis: { textStyle: {fontSize: 12} }, bar: { groupWidth: '75%' } };
        const chart = new google.visualization.BarChart(document.getElementById('callerPerformanceChart'));
        chart.draw(google.visualization.arrayToDataTable(chartData), options);
    }

    function showKpiDetails(kpiType) {
        let title = '';
        const statusMap = {
            total: '‡§è‡§ï‡•Ç‡§£ ‡§ï‡•â‡§≤‡•ç‡§∏', ptp: '‡§™‡•á‡§Æ‡•á‡§Ç‡§ü‡§ö‡•Ä ‡§§‡§æ‡§∞‡•Ä‡§ñ ‡§®‡§ø‡§∂‡•ç‡§ö‡§ø‡§§', wrongNo: '‡§ö‡•Å‡§ï‡•Ä‡§ö‡§æ ‡§Æ‡•ã‡§¨‡§æ‡§à‡§≤ ‡§®‡§Ç‡§¨‡§∞',
            notPicked: '‡§ï‡•â‡§≤ ‡§ò‡•á‡§§‡§≤‡§æ ‡§®‡§æ‡§π‡•Ä', paidToStaff: '‡§π‡§™‡•ç‡§§‡§æ ‡§∏‡•ç‡§ü‡§æ‡§´‡§ï‡§°‡•á ‡§≠‡§∞‡§≤‡•á‡§≤‡§æ ‡§Ü‡§π‡•á', interestIssue: '‡§µ‡•ç‡§Ø‡§æ‡§ú‡§æ‡§ö‡§æ ‡§á‡§∂‡•ç‡§Ø‡•Ç'
        };
        title = statusMap[kpiType];
        const dataToShow = (kpiType === 'total') ? dailyFilteredData : dailyFilteredData.filter(r => r.status === title);
        displayCustomerModal(`${title} ‡§§‡§™‡§∂‡•Ä‡§≤`, dataToShow);
    }

    function displayCustomerModal(title, customerData) {
        const modal = document.getElementById('customerModal');
        document.getElementById('modalTitle').innerText = `${title} (${customerData.length})`;
        const tableBody = document.getElementById('customerListBody');
        
        if(customerData.length === 0) {
            tableBody.innerHTML = `<tr><td colspan="4" style="text-align:center;">‡§ï‡•ã‡§£‡§§‡•á‡§π‡•Ä ‡§∞‡•á‡§ï‡•â‡§∞‡•ç‡§° ‡§â‡§™‡§≤‡§¨‡•ç‡§ß ‡§®‡§æ‡§π‡•Ä.</td></tr>`;
        } else {
            // **[CHANGE 3]** ‡§§‡§™‡§∂‡•Ä‡§≤ ‡§¶‡§æ‡§ñ‡§µ‡§£‡•ç‡§Ø‡§æ‡§∏‡§æ‡§†‡•Ä ‡§Ö‡§ö‡•Ç‡§ï ‡§≤‡•â‡§ú‡§ø‡§ï
            tableBody.innerHTML = customerData.map(c => {
                let fullDetails = c.status || '';
                
                // ‡§∏‡•ç‡§•‡§ø‡§§‡•Ä‡§®‡•Å‡§∏‡§æ‡§∞ ‡§µ‡§ø‡§∂‡§ø‡§∑‡•ç‡§ü ‡§ï‡•â‡§≤‡§Æ‡§Æ‡§ß‡•Ç‡§® ‡§Æ‡§æ‡§π‡§ø‡§§‡•Ä ‡§ú‡•ã‡§°‡§æ
                if (c.status === '‡§™‡•á‡§Æ‡•á‡§Ç‡§ü‡§ö‡•Ä ‡§§‡§æ‡§∞‡•Ä‡§ñ ‡§®‡§ø‡§∂‡•ç‡§ö‡§ø‡§§' && c.paymentDate) {
                    fullDetails += ` (${c.paymentDate})`;
                } else if (c.status === '‡§π‡§™‡•ç‡§§‡§æ ‡§∏‡•ç‡§ü‡§æ‡§´‡§ï‡§°‡•á ‡§≠‡§∞‡§≤‡•á‡§≤‡§æ ‡§Ü‡§π‡•á' && c.amountPaidTo) {
                    fullDetails += ` (${c.amountPaidTo})`;
                } else if (c.rawDetails && String(c.rawDetails).trim() !== '') {
                    // ‡§á‡§§‡§∞ ‡§∏‡•ç‡§•‡§ø‡§§‡•Ä‡§Ç‡§∏‡§æ‡§†‡•Ä 'Details' ‡§ï‡•â‡§≤‡§Æ‡§Æ‡§ß‡•Ä‡§≤ ‡§Æ‡§æ‡§π‡§ø‡§§‡•Ä ‡§µ‡§æ‡§™‡§∞‡§æ
                    fullDetails += ` (${c.rawDetails})`;
                }

                return `<tr>
                    <td>${c.loanNo || '-'}</td>
                    <td>${c.customerName || '-'}</td>
                    <td>${c.mobileNo || '-'}</td>
                    <td>${fullDetails || '-'}</td>
                </tr>`
            }).join('');
        }
        modal.style.display = 'block';
    }

    function closeModal() {
        document.getElementById('customerModal').style.display = 'none';
    }
</script>
</body>
</html>
