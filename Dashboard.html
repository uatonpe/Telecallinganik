<!DOCTYPE html>
<html lang="mr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>‡§ì‡§°‡•Ä ‡§™‡§∞‡§´‡•â‡§∞‡•ç‡§Æ‡§®‡•ç‡§∏ ‡§°‡•Ö‡§∂‡§¨‡•ã‡§∞‡•ç‡§°</title>
<script src="https://www.gstatic.com/charts/loader.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&family=Noto+Sans+Devanagari:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
    :root {
        --primary-bg: #f0f2f5; --card-bg: #ffffff; --header-bg: #0d47a1; --primary-text: #212529;
        --secondary-text: #6c757d; --accent-blue: #007bff; --accent-green: #28a745;
        --accent-orange: #fd7e14; --accent-red: #dc3545; --accent-purple: #6f42c1; --accent-teal: #20c997; --shadow: 0 4px 12px rgba(0, 0, 0, 0.07);
    }
    body { font-family: 'Poppins', 'Noto Sans Devanagari', sans-serif; background-color: var(--primary-bg); margin: 0; color: var(--primary-text); }
    .header { background: var(--header-bg); padding: 18px 30px; color: white; display: flex; align-items: center; justify-content: space-between; box-shadow: 0 2px 4px rgba(0,0,0,0.2); flex-wrap: wrap; gap: 15px;}
    .header h1 { margin: 0; font-size: 24px; font-weight: 600; }
    .filters { display: flex; align-items: center; gap: 20px; flex-wrap: wrap; }
    .filter-item { display: flex; align-items: center; gap: 8px; }
    .filters label { font-size: 14px; font-weight: 500; }
    .filters input[type="date"], .filters select {
        padding: 8px 12px; border-radius: 6px; border: 1px solid #ffffff55;
        background: #ffffff22; color: white; font-family: inherit; min-width: 150px;
    }
    .filters select option { color: black; background: white; }
    .main-container { padding: 25px; max-width: 1800px; margin: auto; }
    .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 25px; margin-bottom: 25px; }
    .kpi-card { display: flex; align-items: center; gap: 20px; background: var(--card-bg); padding: 25px; border-radius: 12px; box-shadow: var(--shadow); transition: transform 0.3s, box-shadow 0.3s; cursor: pointer; }
    .kpi-card:hover { transform: translateY(-5px); box-shadow: 0 8px 16px rgba(0,0,0,0.1); }
    .kpi-icon { width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
    .kpi-icon svg { width: 24px; height: 24px; }
    .kpi-content .value { font-size: 32px; font-weight: 700; color: var(--primary-text); }
    .kpi-content .label { font-size: 15px; color: var(--secondary-text); }
    #kpiCalls .kpi-icon { background: #e6f2ff; color: var(--accent-blue); } #kpiPtp .kpi-icon { background: #eaf7ea; color: var(--accent-green); } #kpiPaidToStaff .kpi-icon { background: #e9f9f5; color: var(--accent-teal); } #kpiInterestIssue .kpi-icon { background: #fff0e0; color: #ff8c00; } #kpiWrongNo .kpi-icon { background: #fff4e6; color: var(--accent-orange); } #kpiNotPicked .kpi-icon { background: #fde8e8; color: var(--accent-red); } #kpiOther .kpi-icon { background: #f2e9fc; color: var(--accent-purple); }
    .dashboard-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 25px; }
    @media (max-width: 1200px) { .dashboard-grid { grid-template-columns: 1fr; } }
    .chart-card { background: var(--card-bg); padding: 25px; border-radius: 12px; box-shadow: var(--shadow); }
    .chart-card h3 { margin-top: 0; font-size: 18px; font-weight: 600; color: var(--header-bg); border-bottom: 1px solid #eee; padding-bottom: 15px; margin-bottom: 20px; }
    .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); }
    .modal-content { background-color: #fefefe; margin: 8% auto; padding: 20px; border-radius: 12px; width: 90%; max-width: 900px; box-shadow: 0 4px 8px 0 rgba(0,0,0,0.2); }
    .modal-header { padding-bottom: 10px; border-bottom: 1px solid #ddd; }
    .modal-header h2 { margin: 0; color: var(--header-bg); }
    .close { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
    #customerListTable, #odTable { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 14px; }
    #customerListTable th, #customerListTable td, #odTable th, #odTable td { border: 1px solid #ddd; padding: 10px; text-align: left; }
    #customerListTable th, #odTable th { background-color: #f2f2f2; font-weight: 600; text-align: center; }
    #odTable .count-cell { cursor: pointer; color: var(--accent-blue); font-weight: bold; text-decoration: underline; }
    #odTable .count-cell:hover { background-color: #e6f2ff; }
    #odTable td { text-align: right; }
    #odTable td:first-child { text-align: left; font-weight: 500;}
    #odTable tfoot td { font-weight: bold; background-color: #f2f2f2; }
</style>
</head>
<body>
<header class="header">
    <h1>üìä ‡§ì‡§°‡•Ä ‡§™‡§∞‡§´‡•â‡§∞‡•ç‡§Æ‡§®‡•ç‡§∏ ‡§°‡•Ö‡§∂‡§¨‡•ã‡§∞‡•ç‡§°</h1>
    <div class="filters">
        <div class="filter-item"><label for="dashboardDate">‡§§‡§æ‡§∞‡•Ä‡§ñ:</label><input type="date" id="dashboardDate"></div>
        <div class="filter-item"><label for="unitFilter">‡§Ø‡•Å‡§®‡§ø‡§ü:</label><select id="unitFilter"><option value="All">‡§∏‡§∞‡•ç‡§µ ‡§Ø‡•Å‡§®‡§ø‡§ü‡•ç‡§∏</option></select></div>
        <div class="filter-item"><label for="callerFilter">‡§ï‡•â‡§≤‡§∞ (CA):</label><select id="callerFilter"><option value="All">‡§∏‡§∞‡•ç‡§µ ‡§ï‡•â‡§≤‡§∞</option></select></div>
    </div>
</header>
<div class="main-container">
    <div class="kpi-grid">
         <!-- KPI Cards remain the same -->
        <div class="kpi-card" id="kpiCalls" onclick="showKpiDetails('total')"><div class="kpi-icon"><svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 16 16"><path d="M3.654 1.328a.678.678 0 0 0-1.015-.063L1.605 2.3c-.483.484-.661 1.169-.45 1.77a17.6 17.6 0 0 0 4.168 6.608 17.6 17.6 0 0 0 6.608 4.168c.601.211 1.286.033 1.77-.45l1.034-1.034a.678.678 0 0 0-.063-1.015l-2.307-1.794a.68.68 0 0 0-.58-.122l-2.19.547a1.75 1.75 0 0 1-1.657-.459L5.482 8.062a1.75 1.75 0 0 1-.46-1.657l.548-2.19a.68.68 0 0 0-.122-.58z"/></svg></div><div class="kpi-content"><div class="value" id="valTotalCalls">0</div><div class="label">‡§è‡§ï‡•Ç‡§£ ‡§ï‡•â‡§≤‡•ç‡§∏</div></div></div>
        <div class="kpi-card" id="kpiPtp" onclick="showKpiDetails('ptp')"><div class="kpi-icon"><svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 16 16"><path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0m-3.97-3.03a.75.75 0 0 0-1.08.022L7.477 9.417 5.384 7.323a.75.75 0 0 0-1.06 1.06L6.97 11.03a.75.75 0 0 0 1.079-.02l3.992-4.99a.75.75 0 0 0-.01-1.05z"/></svg></div><div class="kpi-content"><div class="value" id="valPtp">0</div><div class="label">‡§™‡•á‡§Æ‡•á‡§Ç‡§ü‡§ö‡•Ä ‡§§‡§æ‡§∞‡•Ä‡§ñ ‡§®‡§ø‡§∂‡•ç‡§ö‡§ø‡§§</div></div></div>
        <div class="kpi-card" id="kpiPaidToStaff" onclick="showKpiDetails('paidToStaff')"><div class="kpi-icon"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M1 3a1 1 0 0 1 1-1h12a1 1 0 0 1 1 1zm12-1a2 2 0 0 0-2-2H4a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2zM15 5a1 1 0 0 1-1 1H2a1 1 0 0 1-1-1V4a1 1 0 0 1 1-1h12a1 1 0 0 1 1 1zM8 8a1 1 0 0 1 1-1h6a1 1 0 0 1 1 1v6a1 1 0 0 1-1 1H9a1 1 0 0 1-1-1z"/></svg></div><div class="kpi-content"><div class="value" id="valPaidToStaff">0</div><div class="label">‡§π‡§™‡•ç‡§§‡§æ ‡§∏‡•ç‡§ü‡§æ‡§´‡§ï‡§°‡•á ‡§≠‡§∞‡§≤‡§æ</div></div></div>
        <div class="kpi-card" id="kpiWrongNo" onclick="showKpiDetails('wrongNo')"><div class="kpi-icon"><svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 16 16"><path d="M11.95.706a.5.5 0 0 1 .547.098l.53.53a.5.5 0 0 1 0 .708L8.835 6.22a.5.5 0 0 1-.707 0l-.53-.53a.5.5 0 0 1 0-.707l4.723-4.184a.5.5 0 0 1 .547-.098zm-2.43 2.585a.5.5 0 0 0-.612.334L8.25 6.342a.5.5 0 0 0 .612.334l.278-.64a.5.5 0 0 0-.333-.612l-.64-.278zm2.59.085a.5.5 0 0 0-.293.425l-.133.728a.5.5 0 0 0 .425.293l.728.133a.5.5 0 0 0 .293-.425l.133-.728a.5.5 0 0 0-.425-.293l-.728-.133zM3.363 7.043a.5.5 0 0 1-.547.098L.53 3.422a.5.5 0 0 1 0-.707L4.723.43a.5.5 0 0 1 .547.098l2.286 3.738a.5.5 0 0 1 0 .707L3.363 7.043zm1.187-1.187a.5.5 0 1 0-.707-.707.5.5 0 0 0 .707.707zm-.707-1.414a.5.5 0 1 0-.707.707.5.5 0 0 0 .707-.707z"/></svg></div><div class="kpi-content"><div class="value" id="valWrongNo">0</div><div class="label">‡§ö‡•Å‡§ï‡•Ä‡§ö‡§æ ‡§Æ‡•ã‡§¨‡§æ‡§à‡§≤ ‡§®‡§Ç‡§¨‡§∞</div></div></div>
        <div class="kpi-card" id="kpiNotPicked" onclick="showKpiDetails('notPicked')"><div class="kpi-icon"><svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 16 16"><path d="M11 1a1 1 0 0 1 1 1v12a1 1 0 0 1-1 1H5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1zM5 0a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2V2a2 2 0 0 0-2-2z"/><path d="M8 14a1 1 0 1 0 0-2 1 1 0 0 0 0 2"/></svg></div><div class="kpi-content"><div class="value" id="valNotPicked">0</div><div class="label">‡§ï‡•â‡§≤ ‡§ò‡•á‡§§‡§≤‡§æ ‡§®‡§æ‡§π‡•Ä</div></div></div>
        <div class="kpi-card" id="kpiOther" onclick="showKpiDetails('other')"><div class="kpi-icon"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1z"/><path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5zm-3-1A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0z"/></svg></div><div class="kpi-content"><div class="value" id="valOther">0</div><div class="label">‡§á‡§§‡§∞</div></div></div>
    </div>
    <div class="dashboard-grid">
        <div class="chart-card"><h3>üìä ‡§Ü‡§ú‡§ö‡•ç‡§Ø‡§æ ‡§ï‡•â‡§≤‡§ö‡•á ‡§™‡•ç‡§∞‡§§‡§ø‡§∏‡§æ‡§¶ ‡§µ‡§∞‡•ç‡§ó‡•Ä‡§ï‡§∞‡§£</h3><div id="statusPieChart" style="width: 100%; height: 400px;"></div></div>
        <div class="chart-card"><h3>üìà ‡§∏‡•Ä.‡§è. ‡§®‡§ø‡§π‡§æ‡§Ø ‡§ì‡§°‡•Ä ‡§µ‡§∞‡•ç‡§ó‡•Ä‡§ï‡§∞‡§£ (OD Classification)</h3><div id="odClassificationTableContainer" style="overflow-x:auto;"></div></div>
    </div>
</div>
<div id="customerModal" class="modal">
    <div class="modal-content">
        <div class="modal-header"><span class="close" onclick="closeModal()">&times;</span><h2 id="modalTitle">‡§§‡§™‡§∂‡•Ä‡§≤</h2></div>
        <div style="max-height: 450px; overflow-y: auto;">
            <table id="customerListTable">
                <thead id="modalTableHeader"></thead>
                <tbody id="modalTableBody"></tbody>
            </table>
        </div>
    </div>
</div>

<script>
    const API_KEY = "AIzaSyCib9D8dkRRV7MyGDfTcCqaubl19RnCdhQ"; // <<--- ‡§§‡•Å‡§Æ‡§ö‡•Ä API Key ‡§Ø‡•á‡§•‡•á ‡§ü‡§æ‡§ï‡§æ
    const SPREADSHEET_ID = "1CW1mC206dts-42HOM81X6xVwhtwz70gjD9kyzT0Pwc8"; // <<--- ‡§§‡•Å‡§Æ‡§ö‡§æ Spreadsheet ID ‡§Ø‡•á‡§•‡•á ‡§ü‡§æ‡§ï‡§æ
    
    const LOG_SHEET_NAME = "CallLogs";
    const MASTER_DATA_SHEET_NAME = "MasterData";

    let allCallData = [];
    let allMasterData = [];
    let dailyFilteredData = [];
    let _currentOdData = {};

    document.addEventListener('DOMContentLoaded', () => {
        const today = new Date().toISOString().slice(0, 10);
        document.getElementById('dashboardDate').value = today;
        ['dashboardDate', 'unitFilter', 'callerFilter'].forEach(id => document.getElementById(id).addEventListener('change', updateDashboard));
        google.charts.load('current', {'packages':['corechart']});
        google.charts.setOnLoadCallback(fetchData);
    });

    async function fetchData() {
        try {
            const ranges = [`${LOG_SHEET_NAME}!A:I`, `${MASTER_DATA_SHEET_NAME}!A:K`];
            const response = await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values:batchGet?ranges=${ranges.join('&ranges=')}&key=${API_KEY}`);
            if (!response.ok) throw new Error(`Google Sheets API error: ${response.status} ${response.statusText}`);
            const data = await response.json();

            const callLogRows = data.valueRanges[0].values || [];
            const masterDataRows = data.valueRanges[1].values || [];
            
            if (masterDataRows.length < 2) { console.warn("MasterData sheet is empty."); return; }

            const masterHeaders = masterDataRows.shift().map(h => String(h).trim());
            const loanNoIndex_master = masterHeaders.indexOf("‡§≤‡•ã‡§® ‡§®‡§Ç‡§¨‡§∞");
            const customerNameIndex_master = masterHeaders.indexOf("‡§ó‡•ç‡§∞‡§æ‡§π‡§ï‡§æ‡§Ç‡§ö‡•á ‡§®‡§æ‡§Ç‡§µ");
            let unitIndex_master = masterHeaders.indexOf("‡§Ø‡•Å‡§®‡§ø‡§ü ‡§®‡§æ‡§Ç‡§µ");
            if (unitIndex_master === -1) unitIndex_master = masterHeaders.indexOf("‡§Ø‡•Å‡§®‡§ø‡§ü ‡§®‡§æ‡§Ç‡§µ");
            const mobileIndex_master = masterHeaders.indexOf("‡§Æ‡•ã‡§¨‡§æ‡§à‡§≤ ‡§®‡§Ç‡§¨‡§∞");
            const odDaysIndex_master = masterHeaders.indexOf("‡§ï‡§ø‡§§‡•Ä ‡§¶‡§ø‡§µ‡§∏‡§æ‡§Ç‡§™‡§æ‡§∏‡•Å‡§® ‡§ì‡§°‡•Ä");
            const amountIndex_master = masterHeaders.indexOf("‡§è‡§ï‡•Å‡§£");

            if ([loanNoIndex_master, customerNameIndex_master, unitIndex_master, odDaysIndex_master, amountIndex_master].includes(-1)) {
                alert("‡§§‡•ç‡§∞‡•Å‡§ü‡•Ä: 'MasterData' ‡§∂‡•Ä‡§ü‡§Æ‡§ß‡•ç‡§Ø‡•á ‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï ‡§ï‡•â‡§≤‡§Æ (‡§â‡§¶‡§æ. ‡§≤‡•ã‡§® ‡§®‡§Ç‡§¨‡§∞, ‡§ó‡•ç‡§∞‡§æ‡§π‡§ï‡§ö‡•á ‡§®‡§æ‡§Ç‡§µ, ‡§Ø‡•Å‡§®‡§ø‡§ü ‡§®‡§æ‡§Ç‡§µ, ‡§ï‡§ø‡§§‡•Ä ‡§¶‡§ø‡§µ‡§∏‡§æ‡§Ç‡§™‡§æ‡§∏‡•Ç‡§®, ‡§è‡§ï‡•Ç‡§£) ‡§∏‡§æ‡§™‡§°‡§≤‡•á ‡§®‡§æ‡§π‡•Ä‡§§. ‡§ï‡•É‡§™‡§Ø‡§æ ‡§∏‡•ç‡§™‡•á‡§≤‡§ø‡§Ç‡§ó ‡§§‡§™‡§æ‡§∏‡§æ.");
                return;
            }

            const loanDetailsLookup = new Map();
            const uniqueUnits = new Set();
            
            allMasterData = masterDataRows.map(row => {
                 const loanNo = row[loanNoIndex_master];
                 if (!loanNo) return null;
                 const unit = row[unitIndex_master] || '‡§Ö‡§ú‡•ç‡§û‡§æ‡§§';
                 if (unit !== '‡§Ö‡§ú‡•ç‡§û‡§æ‡§§') uniqueUnits.add(unit);
                 
                 const masterDetails = {
                    loanNo: String(loanNo).trim(),
                    customerName: row[customerNameIndex_master] || 'N/A',
                    unit: unit,
                    mobileNo: row[mobileIndex_master] || '-',
                    odDays: parseInt(row[odDaysIndex_master], 10) || 0,
                    amount: parseFloat(String(row[amountIndex_master]).replace(/,/g, '')) || 0
                 };
                 loanDetailsLookup.set(masterDetails.loanNo, masterDetails);
                 return masterDetails;
            }).filter(item => item !== null);
            populateUnitFilter(uniqueUnits);

            if (callLogRows.length > 1) {
                const callLogHeaders = callLogRows.shift().map(h => String(h).trim());
                const dateIndex = callLogHeaders.indexOf("Date");
                const callerIndex = callLogHeaders.indexOf("Caller Name");
                const loanNoIndex_logs = callLogHeaders.indexOf("Loan Number");
                const statusIndex = callLogHeaders.indexOf("Status");
                const detailsIndex = callLogHeaders.indexOf("Details");
                const amountPaidToIndex = callLogHeaders.indexOf("Amount Paid To");
                const paymentDateIndex = callLogHeaders.indexOf("Payment Date");
                
                const uniqueCallers = new Set();
                allCallData = callLogRows.map(row => {
                    const loanNo = String(row[loanNoIndex_logs] || '').trim();
                    const masterInfo = loanDetailsLookup.get(loanNo) || { unit: '‡§Ö‡§ú‡•ç‡§û‡§æ‡§§', customerName: 'N/A', mobileNo: '-' };
                    const callerName = row[callerIndex];
                    if(callerName) uniqueCallers.add(callerName);
                    return {
                        date: row[dateIndex], caller: callerName, loanNo: loanNo,
                        customerName: masterInfo.customerName, status: row[statusIndex] || '',
                        rawDetails: row[detailsIndex], amountPaidTo: row[amountPaidToIndex],
                        paymentDate: row[paymentDateIndex],
                        unit: masterInfo.unit, mobileNo: masterInfo.mobileNo
                    };
                }).filter(row => row.date && row.caller);
                populateCallerFilter(uniqueCallers);
            }
            updateDashboard();
        } catch (error) {
            console.error("Error fetching data:", error);
            alert("‡§°‡•á‡§ü‡§æ ‡§≤‡•ã‡§° ‡§ï‡§∞‡§£‡•ç‡§Ø‡§æ‡§§ ‡§Ö‡§Ø‡§∂‡§∏‡•ç‡§µ‡•Ä. ‡§§‡•Å‡§Æ‡§ö‡•Ä API Key ‡§Ü‡§£‡§ø Spreadsheet ID ‡§¨‡§∞‡•ã‡§¨‡§∞ ‡§Ö‡§∏‡§≤‡•ç‡§Ø‡§æ‡§ö‡•Ä ‡§ñ‡§æ‡§§‡•ç‡§∞‡•Ä ‡§ï‡§∞‡§æ.");
        }
    }
    
    function populateUnitFilter(units) {
        const unitFilter = document.getElementById('unitFilter');
        unitFilter.innerHTML = '<option value="All">‡§∏‡§∞‡•ç‡§µ ‡§Ø‡•Å‡§®‡§ø‡§ü‡•ç‡§∏</option>';
        Array.from(units).sort().forEach(unit => { const option = document.createElement('option'); option.value = unit; option.textContent = unit; unitFilter.appendChild(option); });
    }
    
    function populateCallerFilter(callers) {
        const callerFilter = document.getElementById('callerFilter');
        callerFilter.innerHTML = '<option value="All">‡§∏‡§∞‡•ç‡§µ ‡§ï‡•â‡§≤‡§∞</option>';
        Array.from(callers).sort().forEach(caller => { const option = document.createElement('option'); option.value = caller; option.textContent = caller; callerFilter.appendChild(option); });
    }

    function updateDashboard() {
        const selectedDate = document.getElementById('dashboardDate').value;
        const selectedUnit = document.getElementById('unitFilter').value;
        const selectedCaller = document.getElementById('callerFilter').value;
        
        dailyFilteredData = allCallData.filter(row => row.date === selectedDate && (selectedUnit === 'All' || row.unit === selectedUnit) && (selectedCaller === 'All' || row.caller === selectedCaller));
        
        const kpiCounts = {
            total: dailyFilteredData.length,
            ptp: dailyFilteredData.filter(r => r.status.includes('‡§™‡•á‡§Æ‡•á‡§Ç‡§ü‡§ö‡•Ä ‡§§‡§æ‡§∞‡•Ä‡§ñ')).length,
            paidToStaff: dailyFilteredData.filter(r => r.status.includes('‡§π‡§™‡•ç‡§§‡§æ')).length,
            wrongNo: dailyFilteredData.filter(r => r.status === '‡§ö‡•Å‡§ï‡•Ä‡§ö‡§æ ‡§Æ‡•ã‡§¨‡§æ‡§à‡§≤ ‡§®‡§Ç‡§¨‡§∞').length,
            notPicked: dailyFilteredData.filter(r => r.status === '‡§ï‡•â‡§≤ ‡§ò‡•á‡§§‡§≤‡§æ ‡§®‡§æ‡§π‡•Ä').length,
            other: dailyFilteredData.filter(r => 
                !r.status.includes('‡§™‡•á‡§Æ‡•á‡§Ç‡§ü‡§ö‡•Ä ‡§§‡§æ‡§∞‡•Ä‡§ñ') && !r.status.includes('‡§π‡§™‡•ç‡§§‡§æ') &&
                r.status !== '‡§ö‡•Å‡§ï‡•Ä‡§ö‡§æ ‡§Æ‡•ã‡§¨‡§æ‡§à‡§≤ ‡§®‡§Ç‡§¨‡§∞' && r.status !== '‡§ï‡•â‡§≤ ‡§ò‡•á‡§§‡§≤‡§æ ‡§®‡§æ‡§π‡•Ä'
            ).length
        };

        document.getElementById('valTotalCalls').innerText = kpiCounts.total;
        document.getElementById('valPtp').innerText = kpiCounts.ptp;
        document.getElementById('valPaidToStaff').innerText = kpiCounts.paidToStaff;
        document.getElementById('valWrongNo').innerText = kpiCounts.wrongNo;
        document.getElementById('valNotPicked').innerText = kpiCounts.notPicked;
        document.getElementById('valOther').innerText = kpiCounts.other;

        drawStatusPieChart(dailyFilteredData);
        renderOdTable();
    }
    
    function drawStatusPieChart(data) {
        const statusCounts = data.reduce((acc, row) => { acc[row.status] = (acc[row.status] || 0) + 1; return acc; }, {});
        const chartData = [['‡§∏‡•ç‡§ü‡•á‡§ü‡§∏', '‡§∏‡§Ç‡§ñ‡•ç‡§Ø‡§æ'], ...Object.entries(statusCounts)];
        const options = { pieHole: 0.4, fontName: 'Noto Sans Devanagari', legend: { position: 'bottom' }, chartArea:{left:15,top:20,width:'90%',height:'75%'} };
        const chart = new google.visualization.PieChart(document.getElementById('statusPieChart'));
        chart.draw(google.visualization.arrayToDataTable(chartData.length > 1 ? chartData : [['Data', 0]]), options);
    }

    function renderOdTable() {
        const selectedUnit = document.getElementById('unitFilter').value;
        const selectedCaller = document.getElementById('callerFilter').value;
        const selectedDate = document.getElementById('dashboardDate').value;

        // 1. Get loan numbers based on CA and Date filter from call logs
        const relevantLoansByCaller = allCallData
            .filter(call => call.date === selectedDate)
            .reduce((acc, call) => {
                if (!acc[call.caller]) acc[call.caller] = new Set();
                acc[call.caller].add(call.loanNo);
                return acc;
            }, {});

        // 2. Filter master data based on unit
        let filteredMasterData = (selectedUnit === 'All')
            ? allMasterData
            : allMasterData.filter(item => item.unit === selectedUnit);

        // 3. Further filter master data based on selected CA
        if (selectedCaller !== 'All') {
            const loanSet = relevantLoansByCaller[selectedCaller] || new Set();
            filteredMasterData = filteredMasterData.filter(item => loanSet.has(item.loanNo));
        }

        // 4. Aggregate data by caller and OD bucket
        const odDataByCaller = {};
        filteredMasterData.forEach(item => {
            let itemCaller = '‡§è‡§ï‡•Ç‡§£';
            if (selectedCaller === 'All') {
                for (const [caller, loans] of Object.entries(relevantLoansByCaller)) {
                    if (loans.has(item.loanNo)) {
                        itemCaller = caller;
                        break;
                    }
                }
            } else {
                 itemCaller = selectedCaller;
            }

            if (!odDataByCaller[itemCaller]) {
                odDataByCaller[itemCaller] = {
                    '0-30': { count: 0, amount: 0, customers: [] },
                    '31-60': { count: 0, amount: 0, customers: [] },
                    '61-90': { count: 0, amount: 0, customers: [] },
                    '91+': { count: 0, amount: 0, customers: [] }
                };
            }

            const days = item.odDays;
            const bucket = (days >= 0 && days <= 30) ? '0-30'
                         : (days >= 31 && days <= 60) ? '31-60'
                         : (days >= 61 && days <= 90) ? '61-90'
                         : '91+';
            
            odDataByCaller[itemCaller][bucket].count++;
            odDataByCaller[itemCaller][bucket].amount += item.amount;
            odDataByCaller[itemCaller][bucket].customers.push({ name: item.customerName, amount: item.amount });
        });
        
        _currentOdData = odDataByCaller; // Store for modal click
        
        // 5. Build HTML table
        const container = document.getElementById('odClassificationTableContainer');
        if (Object.keys(odDataByCaller).length === 0) {
            container.innerHTML = '<p style="text-align:center;color:grey;margin-top:50px;">‡§Ø‡§æ ‡§´‡§ø‡§≤‡•ç‡§ü‡§∞‡§∏‡§æ‡§†‡•Ä ‡§ï‡•ã‡§£‡§§‡§æ‡§π‡•Ä OD ‡§°‡•á‡§ü‡§æ ‡§â‡§™‡§≤‡§¨‡•ç‡§ß ‡§®‡§æ‡§π‡•Ä.</p>';
            return;
        }

        let tableHtml = `<table id="odTable">
            <thead>
                <tr>
                    <th rowspan="2">‡§∏‡•Ä.‡§è. ‡§ö‡•á ‡§®‡§æ‡§Ç‡§µ</th>
                    <th colspan="2">0-30 ‡§¶‡§ø‡§µ‡§∏</th>
                    <th colspan="2">31-60 ‡§¶‡§ø‡§µ‡§∏</th>
                    <th colspan="2">61-90 ‡§¶‡§ø‡§µ‡§∏</th>
                    <th colspan="2">91+ ‡§¶‡§ø‡§µ‡§∏</th>
                </tr>
                <tr>
                    <th>‡§ñ‡§æ‡§§‡•á</th><th>‡§∞‡§ï‡•ç‡§ï‡§Æ</th>
                    <th>‡§ñ‡§æ‡§§‡•á</th><th>‡§∞‡§ï‡•ç‡§ï‡§Æ</th>
                    <th>‡§ñ‡§æ‡§§‡•á</th><th>‡§∞‡§ï‡•ç‡§ï‡§Æ</th>
                    <th>‡§ñ‡§æ‡§§‡•á</th><th>‡§∞‡§ï‡•ç‡§ï‡§Æ</th>
                </tr>
            </thead>
            <tbody>`;
        
        const totals = {
            '0-30': { count: 0, amount: 0 }, '31-60': { count: 0, amount: 0 },
            '61-90': { count: 0, amount: 0 }, '91+': { count: 0, amount: 0 }
        };

        const callers = (selectedCaller !== 'All') ? [selectedCaller] : Object.keys(odDataByCaller).sort();
        
        callers.forEach(caller => {
            if (!odDataByCaller[caller]) return;
            tableHtml += `<tr><td>${caller}</td>`;
            ['0-30', '31-60', '61-90', '91+'].forEach(bucket => {
                const data = odDataByCaller[caller][bucket];
                totals[bucket].count += data.count;
                totals[bucket].amount += data.amount;
                tableHtml += `<td class="count-cell" onclick="showOdCustomerDetails('${caller}', '${bucket}')">${data.count}</td>
                              <td>${data.amount.toLocaleString('en-IN')}</td>`;
            });
            tableHtml += `</tr>`;
        });

        tableHtml += `</tbody>`;

        if (selectedCaller === 'All' && callers.length > 1) {
            tableHtml += `<tfoot><tr><td><strong>‡§è‡§ï‡•Ç‡§£</strong></td>`;
            ['0-30', '31-60', '61-90', '91+'].forEach(bucket => {
                tableHtml += `<td><strong>${totals[bucket].count}</strong></td>
                              <td><strong>${totals[bucket].amount.toLocaleString('en-IN')}</strong></td>`;
            });
            tableHtml += `</tr></tfoot>`;
        }

        tableHtml += `</table>`;
        container.innerHTML = tableHtml;
    }

    function showOdCustomerDetails(caller, bucket) {
        if (!_currentOdData[caller] || !_currentOdData[caller][bucket]) return;

        const customers = _currentOdData[caller][bucket].customers;
        const title = `${caller} - ${bucket} ‡§¶‡§ø‡§µ‡§∏‡§æ‡§Ç‡§ö‡•á ‡§ó‡•ç‡§∞‡§æ‡§π‡§ï (${customers.length})`;
        
        const headers = `<tr><th>‡§ó‡•ç‡§∞‡§æ‡§π‡§ï‡§ö‡•á ‡§®‡§æ‡§Ç‡§µ</th><th>‡§ì‡§°‡•Ä ‡§∞‡§ï‡•ç‡§ï‡§Æ</th></tr>`;
        
        let body = '';
        if (customers.length > 0) {
            customers.sort((a,b) => b.amount - a.amount); // Sort by amount descending
            body = customers.map(c => `<tr><td>${c.name}</td><td style="text-align:right;">${c.amount.toLocaleString('en-IN')}</td></tr>`).join('');
        } else {
            body = `<tr><td colspan="2" style="text-align:center;">‡§Ø‡§æ‡§¶‡•Ä ‡§â‡§™‡§≤‡§¨‡•ç‡§ß ‡§®‡§æ‡§π‡•Ä.</td></tr>`;
        }

        openModal(title, headers, body);
    }
    
    function showKpiDetails(kpiType) {
        // ... (this function remains the same as before) ...
    }

    function openModal(title, tableHeaderHtml, tableBodyHtml) {
        document.getElementById('modalTitle').innerText = title;
        document.getElementById('modalTableHeader').innerHTML = tableHeaderHtml;
        document.getElementById('modalTableBody').innerHTML = tableBodyHtml;
        document.getElementById('customerModal').style.display = 'block';
    }

    function closeModal() {
        document.getElementById('customerModal').style.display = 'none';
    }
</script>
</body>
</html>


