<!DOCTYPE html>
<html lang="mr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>‡§ì‡§°‡•Ä ‡§™‡§∞‡§´‡•â‡§∞‡•ç‡§Æ‡§®‡•ç‡§∏ ‡§°‡•Ö‡§∂‡§¨‡•ã‡§∞‡•ç‡§°</title>
<script src="https://www.gstatic.com/charts/loader.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&family=Noto+Sans+Devanagari:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
    :root {
        --primary-bg: #f0f2f5; --card-bg: #ffffff; --header-bg: #0d47a1; --primary-text: #212529;
        --secondary-text: #6c757d; --accent-blue: #007bff; --accent-green: #28a745;
        --accent-orange: #fd7e14; --accent-red: #dc3545; --shadow: 0 4px 12px rgba(0, 0, 0, 0.07);
    }
    body { font-family: 'Poppins', 'Noto Sans Devanagari', sans-serif; background-color: var(--primary-bg); margin: 0; color: var(--primary-text); }
    .header { background: var(--header-bg); padding: 18px 30px; color: white; display: flex; align-items: center; justify-content: space-between; box-shadow: 0 2px 4px rgba(0,0,0,0.2); flex-wrap: wrap; gap: 15px;}
    .header h1 { margin: 0; font-size: 24px; font-weight: 600; }
    .filters { display: flex; align-items: center; gap: 20px; flex-wrap: wrap; }
    .filter-item { display: flex; align-items: center; gap: 8px; }
    .filters label { font-size: 14px; font-weight: 500; }
    .filters input[type="date"], .filters select {
        padding: 8px 12px; border-radius: 6px; border: 1px solid #ffffff55;
        background: #ffffff22; color: white; font-family: inherit;
    }
    .filters select option { color: black; }
    .main-container { padding: 25px; max-width: 1800px; margin: auto; }
    .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 25px; margin-bottom: 25px; }
    .kpi-card { display: flex; align-items: center; gap: 20px; background: var(--card-bg); padding: 25px; border-radius: 12px; box-shadow: var(--shadow); transition: transform 0.3s, box-shadow 0.3s; }
    .kpi-card:hover { transform: translateY(-5px); box-shadow: 0 8px 16px rgba(0,0,0,0.1); }
    .kpi-icon { width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
    .kpi-icon svg { width: 24px; height: 24px; }
    .kpi-content .value { font-size: 32px; font-weight: 700; color: var(--primary-text); }
    .kpi-content .label { font-size: 15px; color: var(--secondary-text); }
    #kpiCalls .kpi-icon { background: #e6f2ff; color: var(--accent-blue); }
    #kpiPtp .kpi-icon { background: #eaf7ea; color: var(--accent-green); }
    #kpiWrongNo .kpi-icon { background: #fff4e6; color: var(--accent-orange); }
    #kpiNotPicked .kpi-icon { background: #fde8e8; color: var(--accent-red); }
    .dashboard-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 25px; }
    @media (max-width: 900px) { .dashboard-grid { grid-template-columns: 1fr; } }
    .chart-card { background: var(--card-bg); padding: 25px; border-radius: 12px; box-shadow: var(--shadow); }
    .chart-card h3 { margin-top: 0; font-size: 18px; font-weight: 600; color: var(--header-bg); border-bottom: 1px solid #eee; padding-bottom: 15px; margin-bottom: 20px; }
    .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); }
    .modal-content { background-color: #fefefe; margin: 10% auto; padding: 20px; border-radius: 12px; width: 80%; max-width: 800px; box-shadow: 0 4px 8px 0 rgba(0,0,0,0.2); }
    .modal-header { padding-bottom: 10px; border-bottom: 1px solid #ddd; }
    .modal-header h2 { margin: 0; color: var(--header-bg); }
    .close { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
    #customerListTable { width: 100%; border-collapse: collapse; margin-top: 20px; }
    #customerListTable th, #customerListTable td { border: 1px solid #ddd; padding: 10px; text-align: left; }
    #customerListTable th { background-color: #f2f2f2; }
</style>
</head>
<body>
<header class="header">
    <h1>üìä ‡§ì‡§°‡•Ä ‡§™‡§∞‡§´‡•â‡§∞‡•ç‡§Æ‡§®‡•ç‡§∏ ‡§°‡•Ö‡§∂‡§¨‡•ã‡§∞‡•ç‡§°</h1>
    <div class="filters">
        <div class="filter-item">
            <label for="dashboardDate">‡§§‡§æ‡§∞‡•Ä‡§ñ:</label>
            <input type="date" id="dashboardDate">
        </div>
        <div class="filter-item">
             <label for="unitFilter">‡§Ø‡•Å‡§®‡§ø‡§ü:</label>
             <select id="unitFilter">
                <option value="All">‡§∏‡§∞‡•ç‡§µ ‡§Ø‡•Å‡§®‡§ø‡§ü‡•ç‡§∏</option>
             </select>
        </div>
    </div>
</header>
<div class="main-container">
    <!-- ... Rest of the HTML is unchanged ... -->
    <div class="kpi-grid">
        <div class="kpi-card" id="kpiCalls"><div class="kpi-icon"><svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 16 16"><path d="M3.654 1.328a.678.678 0 0 0-1.015-.063L1.605 2.3c-.483.484-.661 1.169-.45 1.77a17.6 17.6 0 0 0 4.168 6.608 17.6 17.6 0 0 0 6.608 4.168c.601.211 1.286.033 1.77-.45l1.034-1.034a.678.678 0 0 0-.063-1.015l-2.307-1.794a.68.68 0 0 0-.58-.122l-2.19.547a1.75 1.75 0 0 1-1.657-.459L5.482 8.062a1.75 1.75 0 0 1-.46-1.657l.548-2.19a.68.68 0 0 0-.122-.58z"/></svg></div><div class="kpi-content"><div class="value" id="valTotalCalls">0</div><div class="label">‡§è‡§ï‡•Ç‡§£ ‡§ï‡•â‡§≤‡•ç‡§∏</div></div></div>
        <div class="kpi-card" id="kpiPtp"><div class="kpi-icon"><svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 16 16"><path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0m-3.97-3.03a.75.75 0 0 0-1.08.022L7.477 9.417 5.384 7.323a.75.75 0 0 0-1.06 1.06L6.97 11.03a.75.75 0 0 0 1.079-.02l3.992-4.99a.75.75 0 0 0-.01-1.05z"/></svg></div><div class="kpi-content"><div class="value" id="valPtp">0</div><div class="label">‡§™‡•á‡§Æ‡•á‡§Ç‡§ü‡§ö‡•Ä ‡§§‡§æ‡§∞‡•Ä‡§ñ ‡§®‡§ø‡§∂‡•ç‡§ö‡§ø‡§§</div></div></div>
        <div class="kpi-card" id="kpiWrongNo"><div class="kpi-icon"><svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M1.885.511a1.745 1.745 0 0 1 2.61.163L6.29 2.98c.329.423.445.974.28 1.465l-2.132 2.132a.5.5 0 0 0-.157.278l-.205.615a.5.5 0 0 0 .58.58l.615-.205a.5.5 0 0 0 .278-.157l2.132-2.132a.5.5 0 0 0 .157-.278l.205-.615a.5.5 0 0 0-.58-.58l-.615.205a.5.5 0 0 0-.278.157L5.383 6.94a.5.5 0 0 1-.707 0L3.586 5.854a.5.5 0 0 1 0-.707l2.132-2.132a.5.5 0 0 0-.157-.278L.205 1.375a.5.5 0 0 0-.58.58l.205.615a.5.5 0 0 0 .157.278l2.132 2.132a.5.5 0 0 0 .707 0l1.086-1.086a.5.5 0 0 0 0-.707L1.885.511zM15.115 14.489a1.745 1.745 0 0 1-2.61-.163L9.71 11.02c-.329-.423-.445-.974-.28-1.465l2.132-2.132a.5.5 0 0 0 .157-.278l.205-.615a.5.5 0 0 0-.58-.58l-.615.205a.5.5 0 0 0-.278.157l-2.132 2.132a.5.5 0 0 0-.157.278l-.205.615a.5.5 0 0 0 .58.58l.615-.205a.5.5 0 0 0 .278-.157l2.132-2.132a.5.5 0 0 1 .707 0l1.086 1.086a.5.5 0 0 1 0 .707l-2.132 2.132a.5.5 0 0 0 .157.278l-.205.615a.5.5 0 0 0 .58.58l.615-.205a.5.5 0 0 0 .278-.157L15.489 12.11a1.745 1.745 0 0 1-.163 2.61z"/></svg></div><div class="kpi-content"><div class="value" id="valWrongNo">0</div><div class="label">‡§ö‡•Å‡§ï‡•Ä‡§ö‡•á ‡§Æ‡•ã‡§¨‡§æ‡§à‡§≤ ‡§®‡§Ç‡§¨‡§∞</div></div></div>
        <div class="kpi-card" id="kpiNotPicked"><div class="kpi-icon"><svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 16 16"><path d="M11 1a1 1 0 0 1 1 1v12a1 1 0 0 1-1 1H5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1zM5 0a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2V2a2 2 0 0 0-2-2z"/><path d="M8 14a1 1 0 1 0 0-2 1 1 0 0 0 0 2"/></svg></div><div class="kpi-content"><div class="value" id="valNotPicked">0</div><div class="label">‡§ï‡•â‡§≤ ‡§ò‡•á‡§§‡§≤‡§æ ‡§®‡§æ‡§π‡•Ä</div></div></div>
    </div>
    <div class="dashboard-grid">
        <div class="chart-card"><h3>üìä ‡§Ü‡§ú‡§ö‡•ç‡§Ø‡§æ ‡§ï‡•â‡§≤‡§ö‡•á ‡§™‡•ç‡§∞‡§§‡§ø‡§∏‡§æ‡§¶ ‡§µ‡§∞‡•ç‡§ó‡•Ä‡§ï‡§∞‡§£</h3><div id="statusPieChart" style="width: 100%; height: 400px;"></div></div>
        <div class="chart-card"><h3>üìà ‡§ï‡•â‡§≤‡§∞‡§®‡•Å‡§∏‡§æ‡§∞ ‡§ï‡§æ‡§Æ‡§ó‡§ø‡§∞‡•Ä</h3><div id="callerBarChart" style="width: 100%; height: 400px;"></div></div>
    </div>
</div>
<div id="customerModal" class="modal">
    <div class="modal-content">
        <div class="modal-header"><span class="close" onclick="closeModal()">&times;</span><h2 id="modalTitle">‡§ó‡•ç‡§∞‡§æ‡§π‡§ï‡§æ‡§Ç‡§ö‡•Ä ‡§Ø‡§æ‡§¶‡•Ä</h2></div>
        <div style="max-height: 400px; overflow-y: auto;"><table id="customerListTable"><thead><tr><th>‡§≤‡•ã‡§® ‡§®‡§Ç‡§¨‡§∞</th><th>‡§ó‡•ç‡§∞‡§æ‡§π‡§ï</th><th>‡§§‡§™‡§∂‡•Ä‡§≤</th></tr></thead><tbody id="customerListBody"></tbody></table></div>
    </div>
</div>

<script>
    const API_KEY = "AIzaSyCib9D8dkRRV7MyGDfTcCqaubl19RnCdhQ"; // <<<<<<<<<<<<< ‡§§‡•Å‡§Æ‡§ö‡•Ä API Key ‡§Ø‡•á‡§•‡•á ‡§ü‡§æ‡§ï‡§æ
    const SPREADSHEET_ID = "1CW1mC206dts-42HOM81X6xVwhtwz70gjD9kyzT0Pwc8"; // <<<<<< ‡§§‡•Å‡§Æ‡§ö‡§æ Spreadsheet ID ‡§Ø‡•á‡§•‡•á ‡§ü‡§æ‡§ï‡§æ
    
    // ‡§§‡•Å‡§Æ‡§ö‡•ç‡§Ø‡§æ ‡§¶‡•ã‡§®‡•ç‡§π‡•Ä ‡§∂‡•Ä‡§ü‡•ç‡§∏‡§ö‡•Ä ‡§®‡§æ‡§µ‡•á ‡§Ø‡•á‡§•‡•á ‡§ü‡§æ‡§ï‡§æ
    const LOG_SHEET_NAME = "CallLogs";
    const MASTER_DATA_SHEET_NAME = "MasterData";

    let allCallData = [];

    document.addEventListener('DOMContentLoaded', () => {
        const today = new Date().toISOString().slice(0, 10);
        document.getElementById('dashboardDate').value = today;
        document.getElementById('dashboardDate').addEventListener('change', updateDashboard);
        document.getElementById('unitFilter').addEventListener('change', updateDashboard);
        google.charts.load('current', {'packages':['corechart']});
        google.charts.setOnLoadCallback(fetchData);
    });

    async function fetchData() {
        try {
            // ‡§è‡§ï‡§æ‡§ö ‡§µ‡•á‡§≥‡•Ä ‡§¶‡•ã‡§®‡•ç‡§π‡•Ä ‡§∂‡•Ä‡§ü‡•ç‡§∏‡§Æ‡§ß‡•Ç‡§® ‡§°‡•á‡§ü‡§æ ‡§Æ‡§æ‡§ó‡§µ‡§æ
            const ranges = [`${LOG_SHEET_NAME}!A:G`, `${MASTER_DATA_SHEET_NAME}!A:I`]; // ‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï ‡§ï‡•â‡§≤‡§Æ‡•ç‡§∏‡§®‡•Å‡§∏‡§æ‡§∞ ‡§∞‡•á‡§Ç‡§ú ‡§¨‡§¶‡§≤‡§æ
            const response = await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values:batchGet?ranges=${ranges.join('&ranges=')}&key=${API_KEY}`);
            const data = await response.json();

            // 1. CallLogs ‡§°‡•á‡§ü‡§æ ‡§™‡•ç‡§∞‡•ã‡§∏‡•á‡§∏ ‡§ï‡§∞‡§æ
            const callLogRows = data.valueRanges[0].values || [];
            if (callLogRows.length < 2) {
                allCallData = [];
            } else {
                const callLogHeaders = callLogRows.shift();
                const callLogData = callLogRows.map(row => ({
                    date: row[1], caller: row[2], loanNo: row[3],
                    customerName: row[4], status: row[5], details: row[6]
                }));

                // 2. MasterData ‡§Æ‡§ß‡•Ç‡§® ‡§Ø‡•Å‡§®‡§ø‡§ü‡§ö‡§æ ‡§Æ‡•Ö‡§™ ‡§§‡§Ø‡§æ‡§∞ ‡§ï‡§∞‡§æ
                const masterDataRows = data.valueRanges[1].values || [];
                const masterHeaders = masterDataRows.shift();
                const loanNoIndex = masterHeaders.indexOf("‡§≤‡•ã‡§® ‡§®‡§Ç‡§¨‡§∞");
                const unitIndex = masterHeaders.indexOf("‡§Ø‡•Å‡§®‡§ø‡§ü ‡§®‡§æ‡§Ç‡§µ");
                
                const unitLookup = new Map();
                const uniqueUnits = new Set();
                masterDataRows.forEach(row => {
                    const loanNo = row[loanNoIndex];
                    const unit = row[unitIndex];
                    if (loanNo && unit) {
                        unitLookup.set(loanNo, unit);
                        uniqueUnits.add(unit);
                    }
                });
                
                populateUnitFilter(uniqueUnits);

                // 3. ‡§¶‡•ã‡§®‡•ç‡§π‡•Ä ‡§°‡•á‡§ü‡§æ ‡§è‡§ï‡§§‡•ç‡§∞ ‡§ï‡§∞‡§æ
                allCallData = callLogData.map(call => ({
                    ...call,
                    unit: unitLookup.get(call.loanNo) || '‡§Ö‡§ú‡•ç‡§û‡§æ‡§§' // ‡§ú‡§∞ ‡§Ø‡•Å‡§®‡§ø‡§ü ‡§∏‡§æ‡§™‡§°‡§≤‡•á ‡§®‡§æ‡§π‡•Ä ‡§§‡§∞ '‡§Ö‡§ú‡•ç‡§û‡§æ‡§§' ‡§¶‡§æ‡§ñ‡§µ‡§æ
                }));
            }
            updateDashboard();
        } catch (error) {
            console.error("Error fetching data:", error);
            alert("‡§°‡•á‡§ü‡§æ ‡§≤‡•ã‡§° ‡§ï‡§∞‡§£‡•ç‡§Ø‡§æ‡§§ ‡§Ö‡§Ø‡§∂‡§∏‡•ç‡§µ‡•Ä. ‡§§‡•Å‡§Æ‡§ö‡•Ä API Key ‡§Ü‡§£‡§ø Sheet ID ‡§§‡§™‡§æ‡§∏‡§æ.");
        }
    }

    function populateUnitFilter(units) {
        const unitFilter = document.getElementById('unitFilter');
        // Clear old options except the first one
        unitFilter.innerHTML = '<option value="All">‡§∏‡§∞‡•ç‡§µ ‡§Ø‡•Å‡§®‡§ø‡§ü‡•ç‡§∏</option>';
        units.forEach(unit => {
            const option = document.createElement('option');
            option.value = unit;
            option.textContent = unit;
            unitFilter.appendChild(option);
        });
    }

    function updateDashboard() {
        const selectedDate = document.getElementById('dashboardDate').value;
        const selectedUnit = document.getElementById('unitFilter').value;
        
        const filteredData = allCallData.filter(row => {
            const dateMatch = row.date === selectedDate;
            const unitMatch = (selectedUnit === 'All' || row.unit === selectedUnit);
            return dateMatch && unitMatch;
        });
        
        // Calculate KPIs based on filtered data
        const totalCalls = filteredData.length;
        const ptpCount = filteredData.filter(r => r.status === '‡§™‡•á‡§Æ‡•á‡§Ç‡§ü‡§ö‡•Ä ‡§§‡§æ‡§∞‡•Ä‡§ñ ‡§®‡§ø‡§∂‡•ç‡§ö‡§ø‡§§').length;
        const wrongNoCount = filteredData.filter(r => r.status === '‡§ö‡•Å‡§ï‡•Ä‡§ö‡§æ ‡§Æ‡•ã‡§¨‡§æ‡§à‡§≤ ‡§®‡§Ç‡§¨‡§∞').length;
        const notPickedCount = filteredData.filter(r => r.status === '‡§ï‡•â‡§≤ ‡§ò‡•á‡§§‡§≤‡§æ ‡§®‡§æ‡§π‡•Ä').length;

        document.getElementById('valTotalCalls').innerText = totalCalls;
        document.getElementById('valPtp').innerText = ptpCount;
        document.getElementById('valWrongNo').innerText = wrongNoCount;
        document.getElementById('valNotPicked').innerText = notPickedCount;

        drawStatusPieChart(filteredData);
        drawCallerBarChart(filteredData);
    }
    
    // The rest of the JavaScript functions (drawStatusPieChart, drawCallerBarChart, showCustomerList, closeModal) are unchanged.
    function drawStatusPieChart(data) { const statusCounts = data.reduce((acc, row) => { acc[row.status] = (acc[row.status] || 0) + 1; return acc; }, {}); const chartData = [['‡§∏‡•ç‡§ü‡•á‡§ü‡§∏', '‡§∏‡§Ç‡§ñ‡•ç‡§Ø‡§æ'], ...Object.entries(statusCounts)]; const options = { title: '', pieHole: 0.4, fontName: 'Noto Sans Devanagari', chartArea:{left:10,top:20,width:'90%',height:'80%'} }; const chart = new google.visualization.PieChart(document.getElementById('statusPieChart')); google.visualization.events.addListener(chart, 'select', () => { const selection = chart.getSelection(); if (selection.length > 0) { const selectedStatus = chartData[selection[0].row + 1][0]; showCustomerList(data, selectedStatus); } }); chart.draw(google.visualization.arrayToDataTable(chartData.length > 1 ? chartData : [['Data', 0]]), options); }
    function drawCallerBarChart(data) { const callerCounts = data.reduce((acc, row) => { acc[row.caller] = (acc[row.caller] || 0) + 1; return acc; }, {}); const chartData = [['‡§ï‡•â‡§≤‡§∞', '‡§ï‡•â‡§≤‡•ç‡§∏'], ...Object.entries(callerCounts)]; const options = { title: '', fontName: 'Noto Sans Devanagari', legend: { position: "none" }, chartArea: {width: '75%', height: '80%'}, hAxis: { title: '‡§ï‡•â‡§≤‡•ç‡§∏‡§ö‡•Ä ‡§∏‡§Ç‡§ñ‡•ç‡§Ø‡§æ', titleTextStyle: {italic: false} }, vAxis: {textStyle: {fontSize: 12}} }; const chart = new google.visualization.BarChart(document.getElementById('callerBarChart')); chart.draw(google.visualization.arrayToDataTable(chartData.length > 1 ? chartData : [['Data', 0]]), options); }
    function showCustomerList(data, status) { const filteredCustomers = data.filter(row => row.status === status); const modal = document.getElementById('customerModal'); document.getElementById('modalTitle').innerText = `'${status}' ‡§Ö‡§∏‡§≤‡•á‡§≤‡•á ‡§ó‡•ç‡§∞‡§æ‡§π‡§ï`; const tableBody = document.getElementById('customerListBody'); tableBody.innerHTML = filteredCustomers.map(c => `<tr><td>${c.loanNo}</td><td>${c.customerName}</td><td>${c.details || '-'}</td></tr>`).join(''); modal.style.display = 'block'; }
    function closeModal() { document.getElementById('customerModal').style.display = 'none'; }
</script>
</body>
</html>