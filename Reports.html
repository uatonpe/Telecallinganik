<!DOCTYPE html>
<html lang="mr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>‡§¶‡•à‡§®‡§ø‡§ï ‡§ï‡•â‡§≤‡§ø‡§Ç‡§ó ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&family=Noto+Sans+Devanagari:wght@400;500;600;700&display=swap" rel="stylesheet">

<style>
    :root { 
        --primary-bg: #f0f2f5; 
        --card-bg: #ffffff; 
        --header-bg: #005A9E; 
        --primary-text: #1c1c1c; 
        --secondary-text: #5a5a5a; 
        --border-color: #e0e0e0;
        --header-text-color: #ffffff;
        --success-color: #28a745;
        --success-hover-color: #218838;
        --danger-color: #dc3545;
        --shadow-color: rgba(0, 0, 0, 0.08);
    }
    body { 
        font-family: 'Poppins', 'Noto Sans Devanagari', sans-serif; 
        background-color: var(--primary-bg); 
        margin: 0; 
        color: var(--primary-text); 
    }
    
    /* Filters section */
    .filters-container { 
        background: var(--card-bg); 
        padding: 15px 25px; 
        color: var(--primary-text); 
        display: flex; 
        align-items: center; 
        justify-content: center; 
        gap: 20px; 
        box-shadow: 0 2px 8px var(--shadow-color); 
        flex-wrap: wrap; 
        position: sticky;
        top: 0;
        z-index: 1000;
    }
    .filters-container label { font-size: 14px; font-weight: 500; }
    .filters-container input, .filters-container select, .filters-container button { 
        padding: 8px 12px; 
        border-radius: 6px; 
        border: 1px solid var(--border-color); 
        font-family: inherit; 
        font-size: 14px; 
    }
    .filters-container button { 
        background-color: var(--header-bg); 
        color: var(--header-text-color); 
        cursor: pointer; 
        border-color: var(--header-bg); 
        font-weight: 500;
    }
    .filters-container button:hover { background-color: #00487d; }
    
    /* Print Button Style */
    #printBtn { background-color: var(--danger-color); border-color: var(--danger-color); display: none; }
    #printBtn:hover { background-color: #c82333; }

    /* Report Container */
    #loader { text-align: center; padding: 50px; font-size: 18px; color: var(--secondary-text); }
    .report-container { 
        max-width: 95%; 
        margin: 30px auto; 
        padding: 15px;
    }
    .report-header { text-align: center; margin-bottom: 30px; }
    .report-header h1 { font-size: 24px; color: var(--header-bg); margin-bottom: 5px; }
    
    /* Table Styling */
    .report-section { 
        margin-bottom: 25px;
        background: var(--card-bg);
        border-radius: 8px;
        box-shadow: 0 4px 12px var(--shadow-color);
        padding: 20px 25px;
    }
    .report-section h2 { 
        font-size: 18px; 
        margin: -20px -25px 20px -25px;
        padding: 15px 25px;
        background-color: #f8f9fa;
        border-bottom: 1px solid var(--border-color);
    }
    .detail-table { 
        width: 100%; 
        border-collapse: collapse; 
        font-size: 14px; 
    }
    .detail-table th, .detail-table td { 
        padding: 12px 15px; 
        text-align: left; 
        vertical-align: top;
        border-bottom: 1px solid var(--border-color);
        word-wrap: break-word; 
    }
    .detail-table th { background-color: #f2f2f2; font-weight: 600; }
    
    /* =========================================
       UPDATED FEEDBACK SECTION (New Styles)
       ========================================= */
    .feedback-cell { min-width: 300px; }
    
    /* ‡§ú‡•Å‡§®‡§æ ‡§Ö‡§≠‡§ø‡§™‡•ç‡§∞‡§æ‡§Ø ‡§¶‡§ø‡§∏‡§£‡•ç‡§Ø‡§æ‡§∏‡§æ‡§†‡•Ä ‡§¨‡•â‡§ï‡•ç‡§∏ (Read Only) */
    .history-box {
        background-color: #f8f9fa;
        border: 1px solid #e9ecef;
        padding: 8px;
        border-radius: 4px;
        font-size: 12px;
        color: #666;
        max-height: 100px;
        overflow-y: auto;
        margin-bottom: 8px;
        white-space: pre-wrap;
    }
    .history-box strong { color: #333; display: block; margin-bottom: 2px; }

    .feedback-input-container {
        display: flex;
        align-items: flex-start;
        gap: 8px;
        flex-direction: column; /* ‡§®‡§µ‡•Ä‡§® ‡§¨‡•â‡§ï‡•ç‡§∏ ‡§ñ‡§æ‡§≤‡•Ä ‡§ò‡•á‡§£‡•ç‡§Ø‡§æ‡§∏‡§æ‡§†‡•Ä */
    }
    
    .input-wrapper {
        display: flex;
        width: 100%;
        gap: 8px;
    }

    .feedback-input-container textarea { 
        width: 100%;
        padding: 8px; 
        border: 1px solid #ccc; 
        border-radius: 4px;
        font-family: inherit;
        font-size: 13px;
        resize: vertical;
        min-height: 38px;
    }
    .feedback-input-container button { 
        padding: 8px 15px; 
        background-color: var(--success-color);
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        height: 38px;
        white-space: nowrap;
        align-self: flex-start;
    }
    
    /* Feedback Section - Print View */
    .feedback-print-view {
        display: none;
        white-space: pre-wrap;
        word-break: break-word;
        font-size: 11px;
        line-height: 1.4;
        color: #000;
        padding-top: 5px;
    }

    /* =========================================
       PRINT SPECIFIC STYLES
       ========================================= */
    @media print {
        .no-print, 
        .filters-container, 
        .feedback-input-container, 
        button { 
            display: none !important; 
        }

        .feedback-print-view { 
            display: block !important; 
        }

        body { background-color: #fff; font-size: 10pt; -webkit-print-color-adjust: exact; }
        .report-container { max-width: 100%; margin: 0; padding: 0; }
        .report-section { box-shadow: none; border: 1px solid #ccc; break-inside: avoid; page-break-inside: avoid; margin-bottom: 20px; }
        .detail-table th, .detail-table td { padding: 8px 5px; border: 1px solid #ddd; }
        thead { display: table-header-group; }
        tr { page-break-inside: avoid; }
        
        .history-box { display: none; } /* ‡§™‡•ç‡§∞‡§ø‡§Ç‡§ü ‡§ï‡§∞‡§§‡§æ‡§®‡§æ ‡§µ‡•á‡§ó‡§≥‡§æ ‡§π‡§ø‡§∏‡•ç‡§ü‡•ç‡§∞‡•Ä ‡§¨‡•â‡§ï‡•ç‡§∏ ‡§®‡§ï‡•ã, ‡§™‡•ç‡§∞‡§ø‡§Ç‡§ü ‡§µ‡•ç‡§π‡•ç‡§Ø‡•Ç ‡§Æ‡§ß‡•ç‡§Ø‡•á ‡§∏‡§∞‡•ç‡§µ ‡§Ø‡•á‡§à‡§≤ */

        @page { 
            size: A4 landscape;
            margin: 1cm; 
        }
    }
</style>
</head>
<body>

<div class="no-print filters-container">
    <label for="reportDate">‡§§‡§æ‡§∞‡•Ä‡§ñ:</label>
    <input type="date" id="reportDate">
    <label for="unitFilter">‡§Ø‡•Å‡§®‡§ø‡§ü:</label>
    <select id="unitFilter"><option value="All">‡§∏‡§∞‡•ç‡§µ ‡§Ø‡•Å‡§®‡§ø‡§ü‡•ç‡§∏</option></select>
    <button onclick="generateReport()">‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü ‡§§‡§Ø‡§æ‡§∞ ‡§ï‡§∞‡§æ</button>
    <button id="printBtn" onclick="printReport()">üñ®Ô∏è ‡§™‡•ç‡§∞‡§ø‡§Ç‡§ü ‡§ï‡§∞‡§æ / PDF ‡§∏‡•á‡§µ‡•ç‡§π ‡§ï‡§∞‡§æ</button>
</div>

<div id="loader">‡§°‡•á‡§ü‡§æ ‡§≤‡•ã‡§° ‡§π‡•ã‡§§ ‡§Ü‡§π‡•á, ‡§ï‡•É‡§™‡§Ø‡§æ ‡§•‡§æ‡§Ç‡§¨‡§æ...</div>
<div id="report-content" class="report-container" style="display:none;"></div>

<script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwQ2nItJWbioX_YHFqYc50z6p2sV-BZlmwsUplvGtJSEPHs5GkLwJWaJjcfPmtIVZ8/exec";
    const API_KEY = "AIzaSyCib9D8dkRRV7MyGDfTcCqaubl19RnCdhQ";
    const SPREADSHEET_ID = "1CW1mC206dts-42HOM81X6xVwhtwz70gjD9kyzT0Pwc8";
    
    let allCallData = [];

    document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('reportDate').value = new Date().toISOString().slice(0, 10);
        fetchInitialData();
    });

    async function fetchInitialData() {
        document.getElementById('loader').innerText = '‡§°‡•á‡§ü‡§æ ‡§≤‡•ã‡§° ‡§π‡•ã‡§§ ‡§Ü‡§π‡•á, ‡§ï‡•É‡§™‡§Ø‡§æ ‡§•‡§æ‡§Ç‡§¨‡§æ...';
        try {
            const ranges = [`CallLogs!A:I`, `MasterData!A:K`, `Updates!A:C`];
            const response = await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values:batchGet?ranges=${ranges.join('&ranges=')}&key=${API_KEY}`);
            if (!response.ok) throw new Error(`Google Sheets API error: ${response.status}`);
            const data = await response.json();
            
            const [callLogResponse, masterDataResponse, updatesResponse] = data.valueRanges;
            const callLogRows = callLogResponse.values || [];
            const masterDataRows = masterDataResponse.values || [];
            const updatesRows = updatesResponse.values || [];
            
            // Master Data Processing
            const masterHeaders = masterDataRows.shift() || [];
            const loanNoIndex_master = masterHeaders.indexOf("‡§≤‡•ã‡§® ‡§®‡§Ç‡§¨‡§∞");
            const unitIndex_master = masterHeaders.indexOf("‡§Ø‡•Å‡§®‡§ø‡§ü ‡§®‡§æ‡§Ç‡§µ");
            const caNameIndex_master = masterHeaders.indexOf("‡§∏‡•Ä ‡§ê ‡§ö‡•á ‡§®‡§æ‡§Ç‡§µ");
            const loanDetailsLookup = new Map();
            const uniqueUnits = new Set();
            masterDataRows.forEach(row => {
                const loanNo = row[loanNoIndex_master];
                if (!loanNo) return;
                const unit = row[unitIndex_master] || '‡§Ö‡§ú‡•ç‡§û‡§æ‡§§';
                const caName = row[caNameIndex_master] || '‡§â‡§™‡§≤‡§¨‡•ç‡§ß ‡§®‡§æ‡§π‡•Ä';
                loanDetailsLookup.set(String(loanNo).trim(), { unit, caName });
                if (unit !== '‡§Ö‡§ú‡•ç‡§û‡§æ‡§§') uniqueUnits.add(unit);
            });
            populateUnitFilter(uniqueUnits);

            // Remarks Processing
            const remarksLookup = new Map();
            if (updatesRows.length > 0) {
                const updateHeaders = updatesRows.shift() || [];
                const dateIndex_update = updateHeaders.indexOf("Date");
                const loanNoIndex_update = updateHeaders.indexOf("Loan Number");
                const remarkIndex_update = updateHeaders.indexOf("Remark");
                updatesRows.forEach(row => {
                    const date = row[dateIndex_update];
                    const loanNo = row[loanNoIndex_update];
                    const remark = row[remarkIndex_update] || '';
                    if (date && loanNo) {
                        const key = `${date}_${String(loanNo).trim()}`;
                        remarksLookup.set(key, remark);
                    }
                });
            }
            
            // Call Logs Processing
            if (callLogRows.length > 1) {
                const callLogHeaders = callLogRows.shift() || [];
                const dateIndex = callLogHeaders.indexOf("Date");
                const loanNoIndex_logs = callLogHeaders.indexOf("Loan Number");
                const customerNameIndex = callLogHeaders.indexOf("Customer Name");
                const statusIndex = callLogHeaders.indexOf("Status");
                const detailsIndex = callLogHeaders.indexOf("Details");
                const paymentDateIndex = callLogHeaders.indexOf("Payment Date");
                const amountPaidToIndex = callLogHeaders.indexOf("Amount Paid To");
                
                allCallData = callLogRows.map(row => {
                    const callDate = String(row[dateIndex] || '').trim();
                    const loanNo = String(row[loanNoIndex_logs] || '').trim();
                    const details = loanDetailsLookup.get(loanNo) || { unit: '‡§Ö‡§ú‡•ç‡§û‡§æ‡§§', caName: '‡§â‡§™‡§≤‡§¨‡•ç‡§ß ‡§®‡§æ‡§π‡•Ä' };
                    const remarkKey = `${callDate}_${loanNo}`;
                    const fieldRemark = remarksLookup.get(remarkKey) || '';
                    return {
                        date: callDate, loanNo: loanNo, customerName: row[customerNameIndex] || '‡§Ö‡§ú‡•ç‡§û‡§æ‡§§',
                        status: row[statusIndex] || '‡§á‡§§‡§∞', details: row[detailsIndex] || '',
                        paymentDate: row[paymentDateIndex] || '', amountPaidTo: row[amountPaidToIndex] || '',
                        unit: details.unit, caName: details.caName, fieldRemark: fieldRemark
                    };
                }).filter(row => row.date);
            }
            document.getElementById('loader').innerText = '‡§°‡•á‡§ü‡§æ ‡§≤‡•ã‡§° ‡§ù‡§æ‡§≤‡§æ ‡§Ü‡§π‡•á. ‡§ï‡•É‡§™‡§Ø‡§æ ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü ‡§§‡§Ø‡§æ‡§∞ ‡§ï‡§∞‡§£‡•ç‡§Ø‡§æ‡§∏‡§æ‡§†‡•Ä ‡§™‡§∞‡•ç‡§Ø‡§æ‡§Ø ‡§®‡§ø‡§µ‡§°‡§æ.';
        } catch (error) {
            console.error("Error fetching data:", error);
            document.getElementById('loader').innerText = "‡§§‡•ç‡§∞‡•Å‡§ü‡•Ä: ‡§°‡•á‡§ü‡§æ ‡§≤‡•ã‡§° ‡§π‡•ã‡§ä ‡§∂‡§ï‡§≤‡§æ ‡§®‡§æ‡§π‡•Ä.";
            alert("‡§°‡•á‡§ü‡§æ ‡§≤‡•ã‡§° ‡§ï‡§∞‡§£‡•ç‡§Ø‡§æ‡§§ ‡§Ö‡§Ø‡§∂‡§∏‡•ç‡§µ‡•Ä: " + error.message);
        }
    }

    function populateUnitFilter(units) {
        const unitFilter = document.getElementById('unitFilter');
        unitFilter.innerHTML = '<option value="All">‡§∏‡§∞‡•ç‡§µ ‡§Ø‡•Å‡§®‡§ø‡§ü‡•ç‡§∏</option>';
        Array.from(units).sort().forEach(unit => {
            const option = document.createElement('option');
            option.value = unit; option.textContent = unit;
            unitFilter.appendChild(option);
        });
    }

    function generateReport() {
        const selectedDate = document.getElementById('reportDate').value;
        const selectedUnit = document.getElementById('unitFilter').value;
        if (!selectedDate) { alert("‡§ï‡•É‡§™‡§Ø‡§æ ‡§§‡§æ‡§∞‡•Ä‡§ñ ‡§®‡§ø‡§µ‡§°‡§æ."); return; }
        
        const reportData = allCallData.filter(row => row.date === selectedDate && (selectedUnit === 'All' || row.unit === selectedUnit));
        const reportContainer = document.getElementById('report-content');
        
        if (reportData.length === 0) {
            reportContainer.innerHTML = `<div class="empty-message">‡§¶‡§ø‡§®‡§æ‡§Ç‡§ï ${selectedDate} ‡§∞‡•ã‡§ú‡•Ä '${selectedUnit}' ‡§∏‡§æ‡§†‡•Ä ‡§ï‡•ã‡§£‡§§‡§æ‡§π‡•Ä ‡§°‡•á‡§ü‡§æ ‡§â‡§™‡§≤‡§¨‡•ç‡§ß ‡§®‡§æ‡§π‡•Ä.</div>`;
            reportContainer.style.display = 'block';
            document.getElementById('printBtn').style.display = 'none';
            return;
        }
        
        document.getElementById('loader').style.display = 'none';
        reportContainer.style.display = 'block';
        document.getElementById('printBtn').style.display = 'inline-block';
        
        const ptp = reportData.filter(r => r.status.includes('‡§™‡•á‡§Æ‡•á‡§Ç‡§ü‡§ö‡•Ä ‡§§‡§æ‡§∞‡•Ä‡§ñ'));
        const paidToStaff = reportData.filter(r => r.status.includes('‡§π‡§™‡•ç‡§§‡§æ'));
        const notPicked = reportData.filter(r => r.status === '‡§ï‡•â‡§≤ ‡§ò‡•á‡§§‡§≤‡§æ ‡§®‡§æ‡§π‡•Ä');
        const wrongNo = reportData.filter(r => r.status === '‡§ö‡•Å‡§ï‡•Ä‡§ö‡§æ ‡§Æ‡•ã‡§¨‡§æ‡§à‡§≤ ‡§®‡§Ç‡§¨‡§∞');
        const others = reportData.filter(r => !ptp.includes(r) && !paidToStaff.includes(r) && !notPicked.includes(r) && !wrongNo.includes(r));
        
        let html = `<div class="report-header"><h1>‡§¶‡•à‡§®‡§ø‡§ï ‡§ï‡•â‡§≤‡§ø‡§Ç‡§ó ‡§™‡§∞‡§´‡•â‡§∞‡•ç‡§Æ‡§®‡•ç‡§∏ ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü</h1><p><strong>‡§Ø‡•Å‡§®‡§ø‡§ü:</strong> ${selectedUnit} | <strong>‡§§‡§æ‡§∞‡•Ä‡§ñ:</strong> ${new Date(selectedDate).toLocaleDateString('mr-IN')}</p></div>`;
        
        html += createDetailTable('‡§™‡•á‡§Æ‡•á‡§Ç‡§ü‡§ö‡•Ä ‡§§‡§æ‡§∞‡•Ä‡§ñ ‡§®‡§ø‡§∂‡•ç‡§ö‡§ø‡§§ (PTP)', ['‡§ó‡•ç‡§∞‡§æ‡§π‡§ï', '‡§≤‡•ã‡§® ‡§®‡§Ç‡§¨‡§∞', '‡§∏‡•Ä‡§è', '‡§™‡•á‡§Æ‡•á‡§Ç‡§ü ‡§§‡§æ‡§∞‡•Ä‡§ñ', '‡§Ö‡§≠‡§ø‡§™‡•ç‡§∞‡§æ‡§Ø (Remark)'], ptp, (item) => `<td>${item.customerName}</td><td>${item.loanNo}</td><td>${item.caName}</td><td>${item.paymentDate || '-'}</td>${createFeedbackCell(item)}`);
        html += createDetailTable('‡§π‡§™‡•ç‡§§‡§æ ‡§∏‡•ç‡§ü‡§æ‡§´‡§ï‡§°‡•á ‡§≠‡§∞‡§≤‡§æ', ['‡§ó‡•ç‡§∞‡§æ‡§π‡§ï', '‡§≤‡•ã‡§® ‡§®‡§Ç‡§¨‡§∞', '‡§∏‡•Ä‡§è', '‡§§‡§™‡§∂‡•Ä‡§≤', '‡§Ö‡§≠‡§ø‡§™‡•ç‡§∞‡§æ‡§Ø (Remark)'], paidToStaff, (item) => `<td>${item.customerName}</td><td>${item.loanNo}</td><td>${item.caName}</td><td>${item.amountPaidTo || '-'}</td>${createFeedbackCell(item)}`);
        html += createDetailTable('‡§Ö‡§®‡•Å‡§§‡•ç‡§™‡§æ‡§¶‡§ï ‡§ï‡•â‡§≤‡•ç‡§∏', ['‡§ó‡•ç‡§∞‡§æ‡§π‡§ï', '‡§≤‡•ã‡§® ‡§®‡§Ç‡§¨‡§∞', '‡§∏‡•Ä‡§è', '‡§∏‡•ç‡§•‡§ø‡§§‡•Ä', '‡§Ö‡§≠‡§ø‡§™‡•ç‡§∞‡§æ‡§Ø (Remark)'], [...notPicked, ...wrongNo], (item) => `<td>${item.customerName}</td><td>${item.loanNo}</td><td>${item.caName}</td><td>${item.status}</td>${createFeedbackCell(item)}`);
        html += createDetailTable('‡§á‡§§‡§∞ ‡§ï‡•â‡§≤‡•ç‡§∏', ['‡§ó‡•ç‡§∞‡§æ‡§π‡§ï', '‡§≤‡•ã‡§® ‡§®‡§Ç‡§¨‡§∞', '‡§∏‡•Ä‡§è', '‡§∏‡•ç‡§•‡§ø‡§§‡•Ä', '‡§§‡§™‡§∂‡•Ä‡§≤', '‡§Ö‡§≠‡§ø‡§™‡•ç‡§∞‡§æ‡§Ø (Remark)'], others, (item) => `<td>${item.customerName}</td><td>${item.loanNo}</td><td>${item.caName}</td><td>${item.status}</td><td>${item.details || '-'}</td>${createFeedbackCell(item)}`);
        
        reportContainer.innerHTML = html;
        
        // ‡§®‡§µ‡•Ä‡§® ‡§Ö‡§≠‡§ø‡§™‡•ç‡§∞‡§æ‡§Ø ‡§≤‡§ø‡§π‡§ø‡§§‡§æ‡§®‡§æ ‡§™‡•ç‡§∞‡§ø‡§Ç‡§ü ‡§µ‡•ç‡§π‡•ç‡§Ø‡•Ç ‡§Ö‡§™‡§°‡•á‡§ü ‡§ï‡§∞‡§£‡•ç‡§Ø‡§æ‡§∏‡§æ‡§†‡•Ä (Init)
        document.querySelectorAll('.feedback-input-container textarea').forEach(ta => {
            syncRemark(ta);
        });
    }

    // ‡§ú‡•Å‡§®‡§æ ‡§Ü‡§£‡§ø ‡§®‡§µ‡•Ä‡§® ‡§Ö‡§≠‡§ø‡§™‡•ç‡§∞‡§æ‡§Ø ‡§ú‡•ã‡§°‡•Ç‡§® ‡§™‡•ç‡§∞‡§ø‡§Ç‡§ü ‡§µ‡•ç‡§π‡•ç‡§Ø‡•Ç ‡§¶‡§æ‡§ñ‡§µ‡§æ
    function syncRemark(textarea) {
        const cell = textarea.closest('.feedback-cell');
        const historyText = cell.querySelector('.history-content').innerText.trim();
        const newText = textarea.value.trim();
        const printView = cell.querySelector('.feedback-print-view');
        
        // ‡§™‡•ç‡§∞‡§ø‡§Ç‡§ü ‡§µ‡•ç‡§π‡•ç‡§Ø‡•Ç‡§Æ‡§ß‡•ç‡§Ø‡•á ‡§ú‡•Å‡§®‡§æ + ‡§®‡§µ‡•Ä‡§® ‡§°‡•á‡§ü‡§æ ‡§è‡§ï‡§§‡•ç‡§∞ ‡§¶‡§æ‡§ñ‡§µ‡§æ
        let combinedText = historyText;
        if (newText) {
            combinedText = (combinedText ? combinedText + "\n" : "") + ">> " + newText;
        }
        
        if(printView) {
            printView.textContent = combinedText;
        }
        
        textarea.style.height = 'auto';
        textarea.style.height = (textarea.scrollHeight) + 'px';
    }

    function createFeedbackCell(item) {
        const remarkText = item.fieldRemark ? item.fieldRemark.replace(/</g, "&lt;").replace(/>/g, "&gt;") : "";
        
        // ‡§π‡§ø‡§∏‡•ç‡§ü‡•ç‡§∞‡•Ä ‡§¨‡•â‡§ï‡•ç‡§∏ ‡§´‡§ï‡•ç‡§§ ‡§§‡•á‡§µ‡•ç‡§π‡§æ‡§ö ‡§¶‡§æ‡§ñ‡§µ‡§æ ‡§ú‡•á‡§µ‡•ç‡§π‡§æ ‡§ú‡•Å‡§®‡§æ ‡§°‡•á‡§ü‡§æ ‡§Ö‡§∏‡•á‡§≤
        const historyDisplay = remarkText ? 
            `<div class="history-box"><strong>‡§Æ‡§æ‡§ó‡•Ä‡§≤ ‡§®‡•ã‡§Ç‡§¶‡•Ä:</strong><span class="history-content">${remarkText}</span></div>` : 
            `<div class="history-box" style="display:none"><strong>‡§Æ‡§æ‡§ó‡•Ä‡§≤ ‡§®‡•ã‡§Ç‡§¶‡•Ä:</strong><span class="history-content"></span></div>`;

        return `
            <td class="feedback-cell">
                <div class="feedback-input-container">
                    <!-- ‡§ú‡•Å‡§®‡§æ ‡§°‡•á‡§ü‡§æ (History) -->
                    ${historyDisplay}
                    
                    <!-- ‡§®‡§µ‡•Ä‡§® ‡§°‡•á‡§ü‡§æ‡§∏‡§æ‡§†‡•Ä ‡§á‡§®‡§™‡•Å‡§ü ‡§¨‡•â‡§ï‡•ç‡§∏ -->
                    <div class="input-wrapper">
                        <textarea id="new-remark-${item.loanNo}" oninput="syncRemark(this)" placeholder="‡§®‡§µ‡•Ä‡§® ‡§Ö‡§≠‡§ø‡§™‡•ç‡§∞‡§æ‡§Ø ‡§á‡§•‡•á ‡§≤‡§ø‡§π‡§æ..."></textarea>
                        <button onclick="saveRemark('${item.date}', '${item.loanNo}')">‡§∏‡•á‡§µ‡•ç‡§π</button>
                    </div>
                </div>
                <!-- ‡§™‡•ç‡§∞‡§ø‡§Ç‡§ü‡§∏‡§æ‡§†‡•Ä ‡§≤‡§™‡§≤‡•á‡§≤‡§æ Div -->
                <div class="feedback-print-view">${remarkText}</div>
            </td>`;
    }

    async function saveRemark(date, loanNumber) {
        const newRemarkInput = document.getElementById(`new-remark-${loanNumber}`);
        const newRemarkVal = newRemarkInput.value.trim();
        const cell = newRemarkInput.closest('.feedback-cell');
        const historyContentSpan = cell.querySelector('.history-content');
        let oldHistory = historyContentSpan.innerText.trim();
        
        const button = newRemarkInput.nextElementSibling;
        
        if (!newRemarkVal) { alert("‡§ï‡•É‡§™‡§Ø‡§æ ‡§ï‡§æ‡§π‡•Ä‡§§‡§∞‡•Ä ‡§®‡§µ‡•Ä‡§® ‡§≤‡§ø‡§π‡§æ."); return; }

        button.textContent = '...';
        button.disabled = true;

        // ** ‡§Æ‡§π‡§§‡•ç‡§§‡•ç‡§µ‡§æ‡§ö‡§æ ‡§¨‡§¶‡§≤: ‡§ú‡•Å‡§®‡§æ ‡§°‡•á‡§ü‡§æ + ‡§®‡§µ‡•Ä‡§® ‡§°‡•á‡§ü‡§æ ‡§è‡§ï‡§§‡•ç‡§∞ ‡§ï‡§∞‡§£‡•á **
        // ‡§´‡•â‡§∞‡•ç‡§Æ‡•á‡§ü: ‡§ú‡•Å‡§®‡§æ ‡§°‡•á‡§ü‡§æ + (‡§®‡§µ‡•Ä‡§® ‡§ì‡§≥) + [‡§§‡§æ‡§∞‡•Ä‡§ñ ‡§µ‡•á‡§≥] + ‡§®‡§µ‡•Ä‡§® ‡§ï‡•â‡§Æ‡•á‡§Ç‡§ü
        const timestamp = new Date().toLocaleString('mr-IN', { hour12: true });
        const finalRemarkToSend = (oldHistory ? oldHistory + "\n----------------\n" : "") + 
                                  "[" + timestamp + "] " + newRemarkVal;

        try {
            const response = await fetch(SCRIPT_URL, {
                method: 'POST',
                mode: 'cors',
                headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                body: JSON.stringify({ date, loanNumber, remark: finalRemarkToSend })
            });
            const result = await response.json();
            if (result.status === "success") {
                // UI ‡§Ö‡§™‡§°‡•á‡§ü ‡§ï‡§∞‡§æ: ‡§®‡§µ‡•Ä‡§® ‡§ü‡•á‡§ï‡•ç‡§∏‡•ç‡§ü ‡§Ü‡§§‡§æ ‡§π‡§ø‡§∏‡•ç‡§ü‡•ç‡§∞‡•Ä‡§Æ‡§ß‡•ç‡§Ø‡•á ‡§ü‡§æ‡§ï‡§æ ‡§Ü‡§£‡§ø ‡§á‡§®‡§™‡•Å‡§ü ‡§∞‡§ø‡§ï‡§æ‡§Æ‡§æ ‡§ï‡§∞‡§æ
                historyContentSpan.innerText = finalRemarkToSend;
                
                // ‡§π‡§ø‡§∏‡•ç‡§ü‡•ç‡§∞‡•Ä ‡§¨‡•â‡§ï‡•ç‡§∏ ‡§≤‡§™‡§µ‡§≤‡§æ ‡§Ö‡§∏‡•á‡§≤ ‡§§‡§∞ ‡§§‡•ã ‡§¶‡§æ‡§ñ‡§µ‡§æ
                cell.querySelector('.history-box').style.display = 'block';
                
                newRemarkInput.value = ''; // ‡§á‡§®‡§™‡•Å‡§ü ‡§ï‡•ç‡§≤‡§ø‡§Ö‡§∞ ‡§ï‡§∞‡§æ
                syncRemark(newRemarkInput); // ‡§™‡•ç‡§∞‡§ø‡§Ç‡§ü ‡§µ‡•ç‡§π‡•ç‡§Ø‡•Ç ‡§∞‡§ø‡§´‡•ç‡§∞‡•á‡§∂ ‡§ï‡§∞‡§æ
                
                newRemarkInput.style.backgroundColor = '#d4edda';
                setTimeout(() => newRemarkInput.style.backgroundColor = '#fff', 2000);
            } else { throw new Error(result.message); }
        } catch (error) {
            alert("‡§§‡•ç‡§∞‡•Å‡§ü‡•Ä: " + error.message);
            newRemarkInput.style.backgroundColor = '#f8d7da';
        } finally {
            button.textContent = '‡§∏‡•á‡§µ‡•ç‡§π';
            button.disabled = false;
        }
    }

    function createDetailTable(title, headers, data, rowBuilder) {
        if (data.length === 0) return '';
        return `<div class="report-section">
            <h2>${title} (${data.length})</h2>
            <table class="detail-table">
                <thead><tr>${headers.map(h => `<th>${h}</th>`).join('')}</tr></thead>
                <tbody>${data.map(item => `<tr>${rowBuilder(item)}</tr>`).join('')}</tbody>
            </table>
        </div>`;
    }

    function printReport() {
        document.querySelectorAll('textarea').forEach(ta => syncRemark(ta));
        window.print();
    }
</script>
</body>
</html>
