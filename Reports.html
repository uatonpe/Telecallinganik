<!DOCTYPE html>
<html lang="mr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>दैनिक कॉलिंग रिपोर्ट</title>
<!-- Google Fonts -->
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&family=Noto+Sans+Devanagari:wght@400;500;600;700&display=swap" rel="stylesheet">
<!-- PDF Export Library -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<style>
    :root {
        --primary-bg: #f4f7fc; --card-bg: #ffffff; --header-bg: #0d47a1;
        --primary-text: #333; --secondary-text: #555; --border-color: #dee2e6;
    }
    body {
        font-family: 'Poppins', 'Noto Sans Devanagari', sans-serif;
        background-color: var(--primary-bg); margin: 0; color: var(--primary-text);
    }
    .no-print {
        background: var(--header-bg); padding: 15px 25px; color: white;
        display: flex; align-items: center; justify-content: center; gap: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1); flex-wrap: wrap;
    }
    .filters-container label { font-size: 14px; margin-right: 8px; }
    .filters-container input, .filters-container select, .filters-container button {
        padding: 8px 12px; border-radius: 6px; border: 1px solid #ccc;
        font-family: inherit; font-size: 14px;
    }
    .filters-container button {
        background-color: #28a745; color: white; cursor: pointer; border-color: #28a745;
    }
    #downloadPdfBtn {
        background-color: #dc3545; color: white; cursor: pointer; border-color: #dc3545;
    }
    #loader {
        text-align: center; padding: 40px; font-size: 18px; color: var(--secondary-text);
    }
    .report-container {
        max-width: 800px; margin: 30px auto; background: var(--card-bg);
        padding: 25px 40px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        border-radius: 8px;
    }
    .report-header {
        text-align: center; border-bottom: 2px solid var(--header-bg); padding-bottom: 15px; margin-bottom: 25px;
    }
    .report-header h1 { margin: 0; font-size: 24px; color: var(--header-bg); font-weight: 700; }
    .report-header p { margin: 5px 0 0; font-size: 16px; color: var(--secondary-text); }

    .report-section { margin-bottom: 30px; }
    .report-section h2 {
        font-size: 18px; font-weight: 600; color: var(--primary-text);
        border-bottom: 1px solid var(--border-color); padding-bottom: 8px; margin-bottom: 15px;
    }
    .summary-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; text-align: center; }
    .summary-item { background: #f8f9fa; padding: 15px; border-radius: 6px; border: 1px solid #e9ecef; }
    .summary-item .value { font-size: 28px; font-weight: 700; }
    .summary-item .label { font-size: 14px; color: var(--secondary-text); }
    #totalCalls .value { color: #007bff; }
    #successfulCalls .value { color: #28a745; }
    #unsuccessfulCalls .value { color: #dc3545; }

    #analysis-text p {
        background-color: #e9f7ff; border-left: 4px solid #007bff; padding: 15px;
        border-radius: 4px; line-height: 1.7; font-size: 15px;
    }
    .detail-table { width: 100%; border-collapse: collapse; font-size: 14px; }
    .detail-table th, .detail-table td {
        border: 1px solid var(--border-color); padding: 10px; text-align: left;
    }
    .detail-table th { background-color: #f2f2f2; font-weight: 600; }
    .empty-message { text-align: center; color: grey; padding: 20px; }

    /* Print Styles */
    @media print {
        body { background-color: #fff; }
        .no-print { display: none; }
        .report-container {
            box-shadow: none; border: none; margin: 0; max-width: 100%; padding: 0;
        }
    }
</style>
</head>
<body>

<div class="no-print filters-container">
    <label for="reportDate">तारीख:</label>
    <input type="date" id="reportDate">
    <label for="unitFilter">युनिट:</label>
    <select id="unitFilter"><option value="All">सर्व युनिट्स</option></select>
    <button onclick="generateReport()">रिपोर्ट तयार करा</button>
    <button id="downloadPdfBtn" style="display:none;" onclick="downloadPDF()">PDF डाउनलोड करा</button>
</div>

<div id="loader">कृपया रिपोर्ट तयार करण्यासाठी तारीख आणि युनिट निवडा...</div>

<div id="report-content" class="report-container" style="display:none;">
    <!-- Report content will be dynamically generated here -->
</div>

<script>
    const API_KEY = "AIzaSyCib9D8dkRRV7MyGDfTcCqaubl19RnCdhQ"; // तुमचा API Key येथे टाका
    const SPREADSHEET_ID = "1CW1mC206dts-42HOM81X6xVwhtwz70gjD9kyzT0Pwc8"; // तुमचा Spreadsheet ID येथे टाका
    
    const LOG_SHEET_NAME = "CallLogs";
    const MASTER_DATA_SHEET_NAME = "MasterData";

    let allCallData = [];

    document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('reportDate').value = new Date().toISOString().slice(0, 10);
        fetchInitialData();
    });

    async function fetchInitialData() {
        try {
            // <-- बदल 1: दोन्ही शीटमधील सर्व आवश्यक कॉलम वाचण्यासाठी रेंज वाढवली
            const ranges = [`${LOG_SHEET_NAME}!A:I`, `${MASTER_DATA_SHEET_NAME}!A:K`];
            const response = await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values:batchGet?ranges=${ranges.join('&ranges=')}&key=${API_KEY}`);
            if (!response.ok) throw new Error(`Google Sheets API error: ${response.status}`);
            const data = await response.json();

            const callLogRows = data.valueRanges[0].values || [];
            const masterDataRows = data.valueRanges[1].values || [];
            
            // Process Master Data
            const masterHeaders = masterDataRows.shift() || [];
            const loanNoIndex_master = masterHeaders.indexOf("लोन नंबर");
            const unitIndex_master = masterHeaders.indexOf("युनिट नांव");
            const caNameIndex_master = masterHeaders.indexOf("सी ऐ चे नांव"); // <-- बदल 2: 'सी ऐ चे नांव' कॉलमचा इंडेक्स मिळवला

            const loanDetailsLookup = new Map();
            const uniqueUnits = new Set();
            
            masterDataRows.forEach(row => {
                 const loanNo = row[loanNoIndex_master];
                 if (!loanNo) return;
                 const unit = row[unitIndex_master] || 'अज्ञात';
                 const caName = row[caNameIndex_master] || 'उपलब्ध नाही'; // <-- बदल 3: सीएचे नाव वाचले
                 
                 // <-- बदल 4: लोन नंबर सोबत युनिट आणि सीएचे नाव दोन्ही साठवले
                 loanDetailsLookup.set(String(loanNo).trim(), { unit, caName }); 
                 
                 if(unit !== 'अज्ञात') uniqueUnits.add(unit);
            });
            
            populateUnitFilter(uniqueUnits);

            // Process Call Logs
            if (callLogRows.length > 1) {
                const callLogHeaders = callLogRows.shift() || [];
                const dateIndex = callLogHeaders.indexOf("Date");
                const loanNoIndex_logs = callLogHeaders.indexOf("Loan Number");
                const customerNameIndex = callLogHeaders.indexOf("Customer Name");
                const statusIndex = callLogHeaders.indexOf("Status");
                const detailsIndex = callLogHeaders.indexOf("Details");
                const paymentDateIndex = callLogHeaders.indexOf("Payment Date");
                const amountPaidToIndex = callLogHeaders.indexOf("Amount Paid To");

                allCallData = callLogRows.map(row => {
                    const loanNo = row[loanNoIndex_logs];
                    // <-- बदल 5: लोन नंबरवरून युनिट आणि सीएचे नाव दोन्ही मिळवले
                    const details = loanDetailsLookup.get(String(loanNo).trim()) || { unit: 'अज्ञात', caName: 'उपलब्ध नाही' };
                    
                    return {
                        date: String(row[dateIndex] || '').trim(),
                        loanNo: loanNo,
                        customerName: row[customerNameIndex] || 'अज्ञात',
                        status: row[statusIndex] || 'इतर',
                        details: row[detailsIndex] || '',
                        paymentDate: row[paymentDateIndex] || '',
                        amountPaidTo: row[amountPaidToIndex] || '',
                        unit: details.unit,
                        caName: details.caName // <-- बदल 6: सीएचे नाव कॉल डेटासोबत जोडले
                    };
                }).filter(row => row.date);
            }
            document.getElementById('loader').innerText = 'डेटा लोड झाला आहे. कृपया रिपोर्ट तयार करण्यासाठी पर्याय निवडा.';
        } catch (error) {
            console.error("Error fetching data:", error);
            document.getElementById('loader').innerText = "त्रुटी: डेटा लोड होऊ शकला नाही. कृपया API Key/Sheet ID तपासा.";
            alert("डेटा लोड करण्यात अयशस्वी. कृपया तुमची API Key आणि Spreadsheet ID तपासा.");
        }
    }

    function populateUnitFilter(units) {
        const unitFilter = document.getElementById('unitFilter');
        Array.from(units).sort().forEach(unit => {
            const option = document.createElement('option');
            option.value = unit; option.textContent = unit;
            unitFilter.appendChild(option);
        });
    }

    function generateReport() {
        const selectedDate = document.getElementById('reportDate').value;
        const selectedUnit = document.getElementById('unitFilter').value;

        if (!selectedDate || !selectedUnit) {
            alert("कृपया तारीख आणि युनिट निवडा.");
            return;
        }

        const reportData = allCallData.filter(row => row.date === selectedDate && (selectedUnit === 'All' || row.unit === selectedUnit));
        const reportContainer = document.getElementById('report-content');

        if (reportData.length === 0) {
            document.getElementById('loader').innerText = `दिनांक ${selectedDate} रोजी '${selectedUnit}' या युनिटसाठी कोणताही कॉलिंग डेटा उपलब्ध नाही.`;
            reportContainer.style.display = 'none';
            document.getElementById('downloadPdfBtn').style.display = 'none';
            return;
        }

        document.getElementById('loader').style.display = 'none';
        reportContainer.style.display = 'block';
        document.getElementById('downloadPdfBtn').style.display = 'inline-block';

        const totalCalls = reportData.length;
        const ptp = reportData.filter(r => r.status.includes('पेमेंटची तारीख'));
        const paidToStaff = reportData.filter(r => r.status.includes('हप्ता'));
        const notPicked = reportData.filter(r => r.status === 'कॉल घेतला नाही');
        const wrongNo = reportData.filter(r => r.status === 'चुकीचा मोबाईल नंबर');
        const others = reportData.filter(r => !ptp.includes(r) && !paidToStaff.includes(r) && !notPicked.includes(r) && !wrongNo.includes(r));
        const successfulCalls = ptp.length + paidToStaff.length;
        const unsuccessfulCalls = notPicked.length + wrongNo.length;

        let html = `
            <div class="report-header">
                <h1>दैनिक कॉलिंग परफॉर्मन्स रिपोर्ट</h1>
                <p><strong>युनिट:</strong> ${selectedUnit} | <strong>तारीख:</strong> ${new Date(selectedDate).toLocaleDateString('mr-IN')}</p>
            </div>
            <div class="report-section">
                <h2>सारांश (Summary)</h2>
                <div class="summary-grid">
                    <div class="summary-item" id="totalCalls"><div class="value">${totalCalls}</div><div class="label">एकूण कॉल्स</div></div>
                    <div class="summary-item" id="successfulCalls"><div class="value">${successfulCalls}</div><div class="label">यशस्वी कॉल्स</div></div>
                    <div class="summary-item" id="unsuccessfulCalls"><div class="value">${unsuccessfulCalls}</div><div class="label">अयशस्वी कॉल्स</div></div>
                </div>
            </div>
            <div class="report-section">
                <h2>विश्लेषण (Analysis)</h2>
                <div id="analysis-text">
                    <p>
                        आज <strong>${selectedUnit}</strong> युनिटमध्ये एकूण <strong>${totalCalls}</strong> ग्राहकांना कॉल करण्यात आले.
                        त्यापैकी <strong>${successfulCalls}</strong> कॉल्स यशस्वी ठरले, ज्यामध्ये <strong>${ptp.length}</strong> ग्राहकांनी पेमेंटची तारीख निश्चित केली आणि <strong>${paidToStaff.length}</strong> ग्राहकांनी स्टाफकडे हप्ता भरल्याचे सांगितले.
                        <br>
                        <strong>${unsuccessfulCalls}</strong> कॉल्स अयशस्वी झाले, ज्यात <strong>${notPicked.length}</strong> कॉल्स उचलले गेले नाहीत आणि <strong>${wrongNo.length}</strong> क्रमांक चुकीचे आढळले. यावर लक्ष देण्याची गरज आहे.
                    </p>
                </div>
            </div>`;
            
        // --- Detailed Tables ---
        // <-- बदल 7: प्रत्येक टेबलमध्ये 'सीएचे नाव' आणि संबंधित डेटा जोडला
        html += createDetailTable('पेमेंटची तारीख निश्चित (PTP)', ['ग्राहक', 'लोन नंबर', 'सीएचे नाव', 'पेमेंटची तारीख'], ptp, (item) => `<td>${item.customerName}</td><td>${item.loanNo}</td><td>${item.caName}</td><td>${item.paymentDate || '-'}</td>`);
        html += createDetailTable('हप्ता स्टाफकडे भरला', ['ग्राहक', 'लोन नंबर', 'सीएचे नाव', 'तपशील'], paidToStaff, (item) => `<td>${item.customerName}</td><td>${item.loanNo}</td><td>${item.caName}</td><td>${item.amountPaidTo || '-'}</td>`);
        html += createDetailTable('अनुत्पादक कॉल्स (Unproductive Calls)', ['ग्राहक', 'लोन नंबर', 'सीएचे नाव', 'स्थिती'], [...notPicked, ...wrongNo], (item) => `<td>${item.customerName}</td><td>${item.loanNo}</td><td>${item.caName}</td><td>${item.status}</td>`);
        html += createDetailTable('इतर कॉल्स', ['ग्राहक', 'लोन नंबर', 'सीएचे नाव', 'स्थिती', 'तपशील'], others, (item) => `<td>${item.customerName}</td><td>${item.loanNo}</td><td>${item.caName}</td><td>${item.status}</td><td>${item.details || '-'}</td>`);
        
        reportContainer.innerHTML = html;
    }

    function createDetailTable(title, headers, data, rowBuilder) {
        let tableHtml = `
            <div class="report-section">
                <h2>${title} (${data.length})</h2>`;

        if (data.length === 0) {
            tableHtml += `<div class="empty-message">या प्रकारात कोणताही डेटा उपलब्ध नाही.</div>`;
        } else {
            tableHtml += `
                <table class="detail-table">
                    <thead><tr><th>${headers.join('</th><th>')}</th></tr></thead>
                    <tbody>
                        ${data.map(item => `<tr>${rowBuilder(item)}</tr>`).join('')}
                    </tbody>
                </table>`;
        }
        tableHtml += `</div>`;
        return tableHtml;
    }

    function downloadPDF() {
        const element = document.getElementById('report-content');
        const selectedUnit = document.getElementById('unitFilter').value;
        const selectedDate = document.getElementById('reportDate').value;
        
        const opt = {
            margin:       0.5,
            filename:     `Calling_Report_${selectedUnit}_${selectedDate}.pdf`,
            image:        { type: 'jpeg', quality: 0.98 },
            html2canvas:  { scale: 2, useCORS: true },
            jsPDF:        { unit: 'in', format: 'a4', orientation: 'portrait' }
        };

        html2pdf().set(opt).from(element).save();
    }
</script>

</body>
</html>
