<!DOCTYPE html>
<html lang="mr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>‡§¶‡•à‡§®‡§ø‡§ï ‡§ï‡•â‡§≤‡§ø‡§Ç‡§ó ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&family=Noto+Sans+Devanagari:wght@400;500;600;700&display=swap" rel="stylesheet">

<style>
    :root { 
        --primary-bg: #f0f2f5; 
        --card-bg: #ffffff; 
        --header-bg: #005A9E; 
        --primary-text: #1c1c1c; 
        --secondary-text: #5a5a5a; 
        --border-color: #e0e0e0;
        --header-text-color: #ffffff;
        --success-color: #28a745;
        --success-hover-color: #218838;
        --danger-color: #dc3545;
        --shadow-color: rgba(0, 0, 0, 0.08);
    }
    body { 
        font-family: 'Poppins', 'Noto Sans Devanagari', sans-serif; 
        background-color: var(--primary-bg); 
        margin: 0; 
        color: var(--primary-text); 
    }
    
    /* Filters section */
    .filters-container { 
        background: var(--card-bg); 
        padding: 15px 25px; 
        color: var(--primary-text); 
        display: flex; 
        align-items: center; 
        justify-content: center; 
        gap: 20px; 
        box-shadow: 0 2px 8px var(--shadow-color); 
        flex-wrap: wrap; 
        position: sticky;
        top: 0;
        z-index: 1000;
    }
    .filters-container label { font-size: 14px; font-weight: 500; }
    .filters-container input, .filters-container select, .filters-container button { 
        padding: 8px 12px; 
        border-radius: 6px; 
        border: 1px solid var(--border-color); 
        font-family: inherit; 
        font-size: 14px; 
    }
    .filters-container button { 
        background-color: var(--header-bg); 
        color: var(--header-text-color); 
        cursor: pointer; 
        border-color: var(--header-bg); 
        font-weight: 500;
    }
    .filters-container button:hover { background-color: #00487d; }
    
    /* Print Button Style */
    #printBtn { background-color: var(--danger-color); border-color: var(--danger-color); display: none; }
    #printBtn:hover { background-color: #c82333; }

    /* Report Container */
    #loader { text-align: center; padding: 50px; font-size: 18px; color: var(--secondary-text); }
    .report-container { 
        max-width: 95%; 
        margin: 30px auto; 
        padding: 15px;
    }
    .report-header { text-align: center; margin-bottom: 30px; }
    .report-header h1 { font-size: 24px; color: var(--header-bg); margin-bottom: 5px; }
    
    /* Table Styling */
    .report-section { 
        margin-bottom: 25px;
        background: var(--card-bg);
        border-radius: 8px;
        box-shadow: 0 4px 12px var(--shadow-color);
        padding: 20px 25px;
    }
    .report-section h2 { 
        font-size: 18px; 
        margin: -20px -25px 20px -25px;
        padding: 15px 25px;
        background-color: #f8f9fa;
        border-bottom: 1px solid var(--border-color);
    }
    .detail-table { 
        width: 100%; 
        border-collapse: collapse; 
        font-size: 14px; 
    }
    .detail-table th, .detail-table td { 
        padding: 12px 15px; 
        text-align: left; 
        vertical-align: top;
        border-bottom: 1px solid var(--border-color);
        word-wrap: break-word; 
    }
    .detail-table th { background-color: #f2f2f2; font-weight: 600; }
    
    /* Feedback Section - Screen View */
    .feedback-cell { min-width: 250px; }
    .feedback-input-container {
        display: flex;
        align-items: flex-start;
        gap: 8px;
    }
    .feedback-input-container textarea { 
        width: 100%;
        padding: 8px; 
        border: 1px solid #ccc; 
        border-radius: 4px;
        font-family: inherit;
        font-size: 14px;
        resize: vertical;
        min-height: 38px;
    }
    .feedback-input-container button { 
        padding: 8px 15px; 
        background-color: var(--success-color);
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        height: 38px;
        white-space: nowrap;
    }
    
    /* Feedback Section - Print View (Default Hidden) */
    .feedback-print-view {
        display: none;
        white-space: pre-wrap; /* ‡§ì‡§≥‡•Ä ‡§ú‡§∂‡§æ‡§ö‡•ç‡§Ø‡§æ ‡§§‡§∂‡§æ ‡§†‡•á‡§µ‡§£‡•ç‡§Ø‡§æ‡§∏‡§æ‡§†‡•Ä */
        word-break: break-word; /* ‡§≤‡§æ‡§Ç‡§¨ ‡§∂‡§¨‡•ç‡§¶ ‡§§‡•ã‡§°‡§£‡•ç‡§Ø‡§æ‡§∏‡§æ‡§†‡•Ä */
        font-size: 12px;
        line-height: 1.5;
        color: #000;
        padding-top: 5px;
    }

    /* =========================================
       PRINT SPECIFIC STYLES (‡§Æ‡§π‡§§‡•ç‡§§‡•ç‡§µ‡§æ‡§ö‡•á)
       ========================================= */
    @media print {
        /* ‡§™‡•ç‡§∞‡§ø‡§Ç‡§ü ‡§ï‡§∞‡§§‡§æ‡§®‡§æ ‡§π‡•á ‡§≤‡§™‡§µ‡§æ */
        .no-print, 
        .filters-container, 
        .feedback-input-container, /* Input box ‡§Ü‡§£‡§ø Save button ‡§≤‡§™‡§µ‡§æ */
        button { 
            display: none !important; 
        }

        /* ‡§™‡•ç‡§∞‡§ø‡§Ç‡§ü ‡§ï‡§∞‡§§‡§æ‡§®‡§æ ‡§π‡•á ‡§¶‡§æ‡§ñ‡§µ‡§æ */
        .feedback-print-view { 
            display: block !important; /* ‡§´‡§ï‡•ç‡§§ ‡§Æ‡§ú‡§ï‡•Ç‡§∞ ‡§¶‡§æ‡§ñ‡§µ‡§æ */
        }

        /* ‡§™‡•á‡§ú ‡§≤‡•á‡§Ü‡§â‡§ü */
        body { background-color: #fff; font-size: 10pt; -webkit-print-color-adjust: exact; }
        .report-container { max-width: 100%; margin: 0; padding: 0; }
        .report-section { box-shadow: none; border: 1px solid #ccc; break-inside: avoid; page-break-inside: avoid; margin-bottom: 20px; }
        .detail-table th, .detail-table td { padding: 8px 5px; border: 1px solid #ddd; }
        
        /* Table Headers ‡§™‡•ç‡§∞‡§§‡•ç‡§Ø‡•á‡§ï ‡§™‡•á‡§ú‡§µ‡§∞ ‡§¶‡§ø‡§∏‡§£‡•ç‡§Ø‡§æ‡§∏‡§æ‡§†‡•Ä */
        thead { display: table-header-group; }
        tr { page-break-inside: avoid; }

        @page { 
            size: A4 landscape; /* ‡§Ü‡§°‡§µ‡•á ‡§™‡•á‡§ú */
            margin: 1cm; 
        }
    }
</style>
</head>
<body>

<div class="no-print filters-container">
    <label for="reportDate">‡§§‡§æ‡§∞‡•Ä‡§ñ:</label>
    <input type="date" id="reportDate">
    <label for="unitFilter">‡§Ø‡•Å‡§®‡§ø‡§ü:</label>
    <select id="unitFilter"><option value="All">‡§∏‡§∞‡•ç‡§µ ‡§Ø‡•Å‡§®‡§ø‡§ü‡•ç‡§∏</option></select>
    <button onclick="generateReport()">‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü ‡§§‡§Ø‡§æ‡§∞ ‡§ï‡§∞‡§æ</button>
    <!-- ‡§®‡§µ‡•Ä‡§® ‡§™‡•ç‡§∞‡§ø‡§Ç‡§ü ‡§¨‡§ü‡§£ -->
    <button id="printBtn" onclick="printReport()">üñ®Ô∏è ‡§™‡•ç‡§∞‡§ø‡§Ç‡§ü ‡§ï‡§∞‡§æ / PDF ‡§∏‡•á‡§µ‡•ç‡§π ‡§ï‡§∞‡§æ</button>
</div>

<div id="loader">‡§°‡•á‡§ü‡§æ ‡§≤‡•ã‡§° ‡§π‡•ã‡§§ ‡§Ü‡§π‡•á, ‡§ï‡•É‡§™‡§Ø‡§æ ‡§•‡§æ‡§Ç‡§¨‡§æ...</div>
<div id="report-content" class="report-container" style="display:none;"></div>

<script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwQ2nItJWbioX_YHFqYc50z6p2sV-BZlmwsUplvGtJSEPHs5GkLwJWaJjcfPmtIVZ8/exec";
    const API_KEY = "AIzaSyCib9D8dkRRV7MyGDfTcCqaubl19RnCdhQ";
    const SPREADSHEET_ID = "1CW1mC206dts-42HOM81X6xVwhtwz70gjD9kyzT0Pwc8";
    
    let allCallData = [];

    document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('reportDate').value = new Date().toISOString().slice(0, 10);
        fetchInitialData();
    });

    async function fetchInitialData() {
        // ... (‡§π‡§æ ‡§≠‡§æ‡§ó ‡§™‡•Ç‡§∞‡•ç‡§µ‡•Ä‡§∏‡§æ‡§∞‡§ñ‡§æ‡§ö ‡§Ü‡§π‡•á - ‡§°‡•á‡§ü‡§æ ‡§´‡•á‡§ö‡§ø‡§Ç‡§ó) ...
        document.getElementById('loader').innerText = '‡§°‡•á‡§ü‡§æ ‡§≤‡•ã‡§° ‡§π‡•ã‡§§ ‡§Ü‡§π‡•á, ‡§ï‡•É‡§™‡§Ø‡§æ ‡§•‡§æ‡§Ç‡§¨‡§æ...';
        try {
            const ranges = [`CallLogs!A:I`, `MasterData!A:K`, `Updates!A:C`];
            const response = await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values:batchGet?ranges=${ranges.join('&ranges=')}&key=${API_KEY}`);
            if (!response.ok) throw new Error(`Google Sheets API error: ${response.status}`);
            const data = await response.json();
            
            const [callLogResponse, masterDataResponse, updatesResponse] = data.valueRanges;
            const callLogRows = callLogResponse.values || [];
            const masterDataRows = masterDataResponse.values || [];
            const updatesRows = updatesResponse.values || [];
            
            // Master Data Processing
            const masterHeaders = masterDataRows.shift() || [];
            const loanNoIndex_master = masterHeaders.indexOf("‡§≤‡•ã‡§® ‡§®‡§Ç‡§¨‡§∞");
            const unitIndex_master = masterHeaders.indexOf("‡§Ø‡•Å‡§®‡§ø‡§ü ‡§®‡§æ‡§Ç‡§µ");
            const caNameIndex_master = masterHeaders.indexOf("‡§∏‡•Ä ‡§ê ‡§ö‡•á ‡§®‡§æ‡§Ç‡§µ");
            const loanDetailsLookup = new Map();
            const uniqueUnits = new Set();
            masterDataRows.forEach(row => {
                const loanNo = row[loanNoIndex_master];
                if (!loanNo) return;
                const unit = row[unitIndex_master] || '‡§Ö‡§ú‡•ç‡§û‡§æ‡§§';
                const caName = row[caNameIndex_master] || '‡§â‡§™‡§≤‡§¨‡•ç‡§ß ‡§®‡§æ‡§π‡•Ä';
                loanDetailsLookup.set(String(loanNo).trim(), { unit, caName });
                if (unit !== '‡§Ö‡§ú‡•ç‡§û‡§æ‡§§') uniqueUnits.add(unit);
            });
            populateUnitFilter(uniqueUnits);

            // Remarks Processing
            const remarksLookup = new Map();
            if (updatesRows.length > 0) {
                const updateHeaders = updatesRows.shift() || [];
                const dateIndex_update = updateHeaders.indexOf("Date");
                const loanNoIndex_update = updateHeaders.indexOf("Loan Number");
                const remarkIndex_update = updateHeaders.indexOf("Remark");
                updatesRows.forEach(row => {
                    const date = row[dateIndex_update];
                    const loanNo = row[loanNoIndex_update];
                    const remark = row[remarkIndex_update] || '';
                    if (date && loanNo) {
                        const key = `${date}_${String(loanNo).trim()}`;
                        remarksLookup.set(key, remark);
                    }
                });
            }
            
            // Call Logs Processing
            if (callLogRows.length > 1) {
                const callLogHeaders = callLogRows.shift() || [];
                const dateIndex = callLogHeaders.indexOf("Date");
                const loanNoIndex_logs = callLogHeaders.indexOf("Loan Number");
                const customerNameIndex = callLogHeaders.indexOf("Customer Name");
                const statusIndex = callLogHeaders.indexOf("Status");
                const detailsIndex = callLogHeaders.indexOf("Details");
                const paymentDateIndex = callLogHeaders.indexOf("Payment Date");
                const amountPaidToIndex = callLogHeaders.indexOf("Amount Paid To");
                
                allCallData = callLogRows.map(row => {
                    const callDate = String(row[dateIndex] || '').trim();
                    const loanNo = String(row[loanNoIndex_logs] || '').trim();
                    const details = loanDetailsLookup.get(loanNo) || { unit: '‡§Ö‡§ú‡•ç‡§û‡§æ‡§§', caName: '‡§â‡§™‡§≤‡§¨‡•ç‡§ß ‡§®‡§æ‡§π‡•Ä' };
                    const remarkKey = `${callDate}_${loanNo}`;
                    const fieldRemark = remarksLookup.get(remarkKey) || '';
                    return {
                        date: callDate, loanNo: loanNo, customerName: row[customerNameIndex] || '‡§Ö‡§ú‡•ç‡§û‡§æ‡§§',
                        status: row[statusIndex] || '‡§á‡§§‡§∞', details: row[detailsIndex] || '',
                        paymentDate: row[paymentDateIndex] || '', amountPaidTo: row[amountPaidToIndex] || '',
                        unit: details.unit, caName: details.caName, fieldRemark: fieldRemark
                    };
                }).filter(row => row.date);
            }
            document.getElementById('loader').innerText = '‡§°‡•á‡§ü‡§æ ‡§≤‡•ã‡§° ‡§ù‡§æ‡§≤‡§æ ‡§Ü‡§π‡•á. ‡§ï‡•É‡§™‡§Ø‡§æ ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü ‡§§‡§Ø‡§æ‡§∞ ‡§ï‡§∞‡§£‡•ç‡§Ø‡§æ‡§∏‡§æ‡§†‡•Ä ‡§™‡§∞‡•ç‡§Ø‡§æ‡§Ø ‡§®‡§ø‡§µ‡§°‡§æ.';
        } catch (error) {
            console.error("Error fetching data:", error);
            document.getElementById('loader').innerText = "‡§§‡•ç‡§∞‡•Å‡§ü‡•Ä: ‡§°‡•á‡§ü‡§æ ‡§≤‡•ã‡§° ‡§π‡•ã‡§ä ‡§∂‡§ï‡§≤‡§æ ‡§®‡§æ‡§π‡•Ä.";
            alert("‡§°‡•á‡§ü‡§æ ‡§≤‡•ã‡§° ‡§ï‡§∞‡§£‡•ç‡§Ø‡§æ‡§§ ‡§Ö‡§Ø‡§∂‡§∏‡•ç‡§µ‡•Ä: " + error.message);
        }
    }

    function populateUnitFilter(units) {
        const unitFilter = document.getElementById('unitFilter');
        unitFilter.innerHTML = '<option value="All">‡§∏‡§∞‡•ç‡§µ ‡§Ø‡•Å‡§®‡§ø‡§ü‡•ç‡§∏</option>';
        Array.from(units).sort().forEach(unit => {
            const option = document.createElement('option');
            option.value = unit; option.textContent = unit;
            unitFilter.appendChild(option);
        });
    }

    function generateReport() {
        const selectedDate = document.getElementById('reportDate').value;
        const selectedUnit = document.getElementById('unitFilter').value;
        if (!selectedDate) { alert("‡§ï‡•É‡§™‡§Ø‡§æ ‡§§‡§æ‡§∞‡•Ä‡§ñ ‡§®‡§ø‡§µ‡§°‡§æ."); return; }
        
        const reportData = allCallData.filter(row => row.date === selectedDate && (selectedUnit === 'All' || row.unit === selectedUnit));
        const reportContainer = document.getElementById('report-content');
        
        if (reportData.length === 0) {
            reportContainer.innerHTML = `<div class="empty-message">‡§¶‡§ø‡§®‡§æ‡§Ç‡§ï ${selectedDate} ‡§∞‡•ã‡§ú‡•Ä '${selectedUnit}' ‡§∏‡§æ‡§†‡•Ä ‡§ï‡•ã‡§£‡§§‡§æ‡§π‡•Ä ‡§°‡•á‡§ü‡§æ ‡§â‡§™‡§≤‡§¨‡•ç‡§ß ‡§®‡§æ‡§π‡•Ä.</div>`;
            reportContainer.style.display = 'block';
            document.getElementById('printBtn').style.display = 'none';
            return;
        }
        
        document.getElementById('loader').style.display = 'none';
        reportContainer.style.display = 'block';
        document.getElementById('printBtn').style.display = 'inline-block';
        
        const ptp = reportData.filter(r => r.status.includes('‡§™‡•á‡§Æ‡•á‡§Ç‡§ü‡§ö‡•Ä ‡§§‡§æ‡§∞‡•Ä‡§ñ'));
        const paidToStaff = reportData.filter(r => r.status.includes('‡§π‡§™‡•ç‡§§‡§æ'));
        const notPicked = reportData.filter(r => r.status === '‡§ï‡•â‡§≤ ‡§ò‡•á‡§§‡§≤‡§æ ‡§®‡§æ‡§π‡•Ä');
        const wrongNo = reportData.filter(r => r.status === '‡§ö‡•Å‡§ï‡•Ä‡§ö‡§æ ‡§Æ‡•ã‡§¨‡§æ‡§à‡§≤ ‡§®‡§Ç‡§¨‡§∞');
        const others = reportData.filter(r => !ptp.includes(r) && !paidToStaff.includes(r) && !notPicked.includes(r) && !wrongNo.includes(r));
        
        let html = `<div class="report-header"><h1>‡§¶‡•à‡§®‡§ø‡§ï ‡§ï‡•â‡§≤‡§ø‡§Ç‡§ó ‡§™‡§∞‡§´‡•â‡§∞‡•ç‡§Æ‡§®‡•ç‡§∏ ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü</h1><p><strong>‡§Ø‡•Å‡§®‡§ø‡§ü:</strong> ${selectedUnit} | <strong>‡§§‡§æ‡§∞‡•Ä‡§ñ:</strong> ${new Date(selectedDate).toLocaleDateString('mr-IN')}</p></div>`;
        
        html += createDetailTable('‡§™‡•á‡§Æ‡•á‡§Ç‡§ü‡§ö‡•Ä ‡§§‡§æ‡§∞‡•Ä‡§ñ ‡§®‡§ø‡§∂‡•ç‡§ö‡§ø‡§§ (PTP)', ['‡§ó‡•ç‡§∞‡§æ‡§π‡§ï', '‡§≤‡•ã‡§® ‡§®‡§Ç‡§¨‡§∞', '‡§∏‡•Ä‡§è', '‡§™‡•á‡§Æ‡•á‡§Ç‡§ü ‡§§‡§æ‡§∞‡•Ä‡§ñ', '‡§Ö‡§≠‡§ø‡§™‡•ç‡§∞‡§æ‡§Ø (Remark)'], ptp, (item) => `<td>${item.customerName}</td><td>${item.loanNo}</td><td>${item.caName}</td><td>${item.paymentDate || '-'}</td>${createFeedbackCell(item)}`);
        html += createDetailTable('‡§π‡§™‡•ç‡§§‡§æ ‡§∏‡•ç‡§ü‡§æ‡§´‡§ï‡§°‡•á ‡§≠‡§∞‡§≤‡§æ', ['‡§ó‡•ç‡§∞‡§æ‡§π‡§ï', '‡§≤‡•ã‡§® ‡§®‡§Ç‡§¨‡§∞', '‡§∏‡•Ä‡§è', '‡§§‡§™‡§∂‡•Ä‡§≤', '‡§Ö‡§≠‡§ø‡§™‡•ç‡§∞‡§æ‡§Ø (Remark)'], paidToStaff, (item) => `<td>${item.customerName}</td><td>${item.loanNo}</td><td>${item.caName}</td><td>${item.amountPaidTo || '-'}</td>${createFeedbackCell(item)}`);
        html += createDetailTable('‡§Ö‡§®‡•Å‡§§‡•ç‡§™‡§æ‡§¶‡§ï ‡§ï‡•â‡§≤‡•ç‡§∏', ['‡§ó‡•ç‡§∞‡§æ‡§π‡§ï', '‡§≤‡•ã‡§® ‡§®‡§Ç‡§¨‡§∞', '‡§∏‡•Ä‡§è', '‡§∏‡•ç‡§•‡§ø‡§§‡•Ä', '‡§Ö‡§≠‡§ø‡§™‡•ç‡§∞‡§æ‡§Ø (Remark)'], [...notPicked, ...wrongNo], (item) => `<td>${item.customerName}</td><td>${item.loanNo}</td><td>${item.caName}</td><td>${item.status}</td>${createFeedbackCell(item)}`);
        html += createDetailTable('‡§á‡§§‡§∞ ‡§ï‡•â‡§≤‡•ç‡§∏', ['‡§ó‡•ç‡§∞‡§æ‡§π‡§ï', '‡§≤‡•ã‡§® ‡§®‡§Ç‡§¨‡§∞', '‡§∏‡•Ä‡§è', '‡§∏‡•ç‡§•‡§ø‡§§‡•Ä', '‡§§‡§™‡§∂‡•Ä‡§≤', '‡§Ö‡§≠‡§ø‡§™‡•ç‡§∞‡§æ‡§Ø (Remark)'], others, (item) => `<td>${item.customerName}</td><td>${item.loanNo}</td><td>${item.caName}</td><td>${item.status}</td><td>${item.details || '-'}</td>${createFeedbackCell(item)}`);
        
        reportContainer.innerHTML = html;
        // Textarea ‡§∏‡§æ‡§á‡§ú ‡§ç‡§°‡§ú‡§∏‡•ç‡§ü ‡§ï‡§∞‡§æ
        document.querySelectorAll('.feedback-input-container textarea').forEach(ta => {
            ta.style.height = 'auto';
            ta.style.height = (ta.scrollHeight) + 'px';
        });
    }

    // ‡§ü‡§æ‡§á‡§™ ‡§ï‡§∞‡§§‡§æ‡§®‡§æ‡§ö ‡§™‡•ç‡§∞‡§ø‡§Ç‡§ü ‡§µ‡•ç‡§π‡•ç‡§Ø‡•Ç ‡§Ö‡§™‡§°‡•á‡§ü ‡§ï‡§∞‡§£‡•á
    function syncRemark(textarea) {
        const printView = textarea.closest('.feedback-cell').querySelector('.feedback-print-view');
        if(printView) {
            printView.textContent = textarea.value;
        }
        // ‡§ë‡§ü‡•ã ‡§π‡§æ‡§à‡§ü
        textarea.style.height = 'auto';
        textarea.style.height = (textarea.scrollHeight) + 'px';
    }

    function createFeedbackCell(item) {
        const remarkText = item.fieldRemark.replace(/</g, "&lt;").replace(/>/g, "&gt;");
        return `
            <td class="feedback-cell">
                <div class="feedback-input-container">
                    <textarea id="remark-${item.loanNo}" oninput="syncRemark(this)" placeholder="‡§Ö‡§≠‡§ø‡§™‡•ç‡§∞‡§æ‡§Ø...">${remarkText}</textarea>
                    <button onclick="saveRemark('${item.date}', '${item.loanNo}')">‡§∏‡•á‡§µ‡•ç‡§π</button>
                </div>
                <!-- ‡§™‡•ç‡§∞‡§ø‡§Ç‡§ü‡§∏‡§æ‡§†‡•Ä ‡§≤‡§™‡§≤‡•á‡§≤‡§æ Div - ‡§π‡§æ ‡§´‡§ï‡•ç‡§§ ‡§™‡•ç‡§∞‡§ø‡§Ç‡§ü‡§Æ‡§ß‡•ç‡§Ø‡•á ‡§¶‡§ø‡§∏‡•á‡§≤ -->
                <div class="feedback-print-view">${remarkText}</div>
            </td>`;
    }

    async function saveRemark(date, loanNumber) {
        const remarkInput = document.getElementById(`remark-${loanNumber}`);
        const remark = remarkInput.value.trim();
        const button = remarkInput.nextElementSibling;
        
        if (!remark) { alert("‡§ï‡•É‡§™‡§Ø‡§æ ‡§Ö‡§≠‡§ø‡§™‡•ç‡§∞‡§æ‡§Ø ‡§≤‡§ø‡§π‡§æ."); return; }

        button.textContent = '...';
        button.disabled = true;

        // ‡§Æ‡•Ö‡§®‡•ç‡§Ø‡•Å‡§Ö‡§≤ ‡§∏‡§ø‡§Ç‡§ï (Safety)
        syncRemark(remarkInput);

        try {
            const response = await fetch(SCRIPT_URL, {
                method: 'POST',
                mode: 'cors',
                headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                body: JSON.stringify({ date, loanNumber, remark })
            });
            const result = await response.json();
            if (result.status === "success") {
                // alert(result.message); // ‡§µ‡§æ‡§∞‡§Ç‡§µ‡§æ‡§∞ ‡§Ö‡§≤‡§∞‡•ç‡§ü ‡§®‡§ï‡•ã ‡§Ö‡§∏‡§≤‡•ç‡§Ø‡§æ‡§∏ ‡§π‡•á ‡§ï‡§Æ‡•á‡§Ç‡§ü ‡§ï‡§∞‡§æ
                remarkInput.style.backgroundColor = '#d4edda';
            } else { throw new Error(result.message); }
        } catch (error) {
            alert("‡§§‡•ç‡§∞‡•Å‡§ü‡•Ä: " + error.message);
            remarkInput.style.backgroundColor = '#f8d7da';
        } finally {
            button.textContent = '‡§∏‡•á‡§µ‡•ç‡§π';
            button.disabled = false;
        }
    }

    function createDetailTable(title, headers, data, rowBuilder) {
        if (data.length === 0) return '';
        return `<div class="report-section">
            <h2>${title} (${data.length})</h2>
            <table class="detail-table">
                <thead><tr>${headers.map(h => `<th>${h}</th>`).join('')}</tr></thead>
                <tbody>${data.map(item => `<tr>${rowBuilder(item)}</tr>`).join('')}</tbody>
            </table>
        </div>`;
    }

    // ‡§™‡•ç‡§∞‡§ø‡§Ç‡§ü ‡§´‡§Ç‡§ï‡•ç‡§∂‡§® - ‡§¨‡•ç‡§∞‡§æ‡§â‡§ù‡§∞ ‡§™‡•ç‡§∞‡§ø‡§Ç‡§ü ‡§°‡§æ‡§Ø‡§≤‡•â‡§ó ‡§â‡§ò‡§°‡•á‡§≤
    function printReport() {
        // ‡§™‡•ç‡§∞‡§ø‡§Ç‡§ü ‡§ï‡§∞‡§£‡•ç‡§Ø‡§æ‡§Ü‡§ß‡•Ä ‡§ñ‡§æ‡§§‡•ç‡§∞‡•Ä ‡§ï‡§∞‡§æ ‡§ï‡•Ä ‡§∏‡§∞‡•ç‡§µ Textarea ‡§Æ‡§ß‡•Ä‡§≤ ‡§Æ‡§ú‡§ï‡•Ç‡§∞ Print Div ‡§Æ‡§ß‡•ç‡§Ø‡•á ‡§ï‡•â‡§™‡•Ä ‡§ù‡§æ‡§≤‡§æ ‡§Ü‡§π‡•á
        document.querySelectorAll('textarea').forEach(ta => syncRemark(ta));
        
        // ‡§¨‡•ç‡§∞‡§æ‡§â‡§ù‡§∞ ‡§™‡•ç‡§∞‡§ø‡§Ç‡§ü ‡§ï‡§Æ‡§æ‡§Ç‡§°
        window.print();
    }
</script>
</body>
</html>
