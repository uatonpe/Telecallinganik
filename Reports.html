<!DOCTYPE html>
<html lang="mr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>दैनिक कॉलिंग रिपोर्ट</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&family=Noto+Sans+Devanagari:wght@400;500;600;700&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<!-- !! व्यावसायिक आणि सुधारित डिझाइनसाठी CSS !! -->
<style>
    :root { 
        --primary-bg: #f0f2f5; 
        --card-bg: #ffffff; 
        --header-bg: #005A9E; 
        --primary-text: #1c1c1c; 
        --secondary-text: #5a5a5a; 
        --border-color: #e0e0e0;
        --header-text-color: #ffffff;
        --success-color: #28a745;
        --success-hover-color: #218838;
        --danger-color: #dc3545;
        --shadow-color: rgba(0, 0, 0, 0.08);
    }
    body { 
        font-family: 'Poppins', 'Noto Sans Devanagari', sans-serif; 
        background-color: var(--primary-bg); 
        margin: 0; 
        color: var(--primary-text); 
    }
    .no-print {
        /* This class will be hidden during printing */
    }
    .filters-container { 
        background: var(--card-bg); 
        padding: 15px 25px; 
        color: var(--primary-text); 
        display: flex; 
        align-items: center; 
        justify-content: center; 
        gap: 20px; 
        box-shadow: 0 2px 8px var(--shadow-color); 
        flex-wrap: wrap; 
        position: sticky;
        top: 0;
        z-index: 1000;
    }
    .filters-container label { font-size: 14px; font-weight: 500; }
    .filters-container input, .filters-container select, .filters-container button { 
        padding: 8px 12px; 
        border-radius: 6px; 
        border: 1px solid var(--border-color); 
        font-family: inherit; 
        font-size: 14px; 
        transition: all 0.2s ease-in-out;
    }
    .filters-container input:focus, .filters-container select:focus {
        border-color: var(--header-bg);
        box-shadow: 0 0 0 2px rgba(0, 90, 158, 0.2);
        outline: none;
    }
    .filters-container button { 
        background-color: var(--header-bg); 
        color: var(--header-text-color); 
        cursor: pointer; 
        border-color: var(--header-bg); 
        font-weight: 500;
    }
    .filters-container button:hover {
        background-color: #00487d;
    }
    #downloadPdfBtn { background-color: var(--danger-color); border-color: var(--danger-color); }
    #loader { text-align: center; padding: 50px; font-size: 18px; color: var(--secondary-text); }
    .report-container { 
        max-width: 95%; 
        margin: 30px auto; 
        padding: 15px;
    }
    .report-header { 
        text-align: center; 
        margin-bottom: 30px; 
    }
    .report-header h1 {
        font-size: 24px;
        color: var(--header-bg);
        font-weight: 700;
        margin-bottom: 5px;
    }
    .report-header p {
        font-size: 16px;
        color: var(--secondary-text);
    }
    .report-section { 
        margin-bottom: 25px;
        background: var(--card-bg);
        border-radius: 8px;
        box-shadow: 0 4px 12px var(--shadow-color);
        padding: 20px 25px;
        overflow-x: auto; /* For smaller screens */
    }
    .report-section h2 { 
        font-size: 18px; 
        font-weight: 600; 
        color: var(--primary-text); 
        padding-bottom: 10px; 
        margin: -20px -25px 20px -25px;
        padding: 15px 25px;
        background-color: #f8f9fa;
        border-bottom: 1px solid var(--border-color);
    }
    .detail-table { 
        width: 100%; 
        border-collapse: collapse; 
        font-size: 14px; 
    }
    .detail-table th, .detail-table td { 
        padding: 12px 15px; 
        text-align: left; 
        vertical-align: middle; 
        border-bottom: 1px solid var(--border-color);
    }
    .detail-table thead th { 
        background-color: #f2f2f2; 
        font-weight: 600; 
        color: var(--primary-text);
        border-bottom-width: 2px;
    }
    .detail-table tbody tr:nth-child(even) {
        background-color: #f9f9f9;
    }
    .detail-table tbody tr:hover {
        background-color: #f1f1f1;
    }
    .empty-message { text-align: center; color: grey; padding: 20px; }
    
    .feedback-cell textarea { 
        width: 100%;
        flex-grow: 1; 
        padding: 8px; 
        border: 1px solid #ccc; 
        border-radius: 4px;
        font-family: inherit;
        font-size: 14px;
        resize: none;
        overflow-y: hidden;
        min-height: 38px;
        transition: border-color 0.2s, box-shadow 0.2s;
    }
    .feedback-cell textarea:focus {
        border-color: var(--header-bg);
        outline: none;
        box-shadow: 0 0 0 2px rgba(13, 71, 161, 0.2);
    }
    .feedback-input-container {
        display: flex;
        align-items: flex-start;
        gap: 8px;
        min-width: 300px;
    }
    .feedback-input-container button { 
        padding: 8px 15px; 
        font-size: 14px; 
        background-color: var(--success-color);
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        transition: background-color 0.2s;
        height: 38px;
    }
    .feedback-input-container button:hover { background-color: var(--success-hover-color); }
    .feedback-input-container button:disabled { background-color: #cccccc; cursor: not-allowed; }
    .feedback-print-view {
        display: none;
        white-space: pre-wrap;
    }

    /* प्रिंटसाठी सुधारित स्टाईल */
    @media print {
        body { background-color: #fff; font-size: 10pt; }
        .no-print { display: none !important; }
        .report-container { max-width: 100%; margin: 0; padding: 0; box-shadow: none; }
        .report-section { box-shadow: none; border: 1px solid #ccc; padding: 15px; page-break-inside: avoid; overflow: hidden; }
        .report-header h1 { font-size: 18pt; }
        .report-header p { font-size: 12pt; }
        
        .detail-table { 
            font-size: 9pt; 
            table-layout: fixed; /* <<-- हा महत्त्वाचा बदल आहे */
            width: 100%;
        }
        .detail-table th, .detail-table td { 
            padding: 8px; 
            word-wrap: break-word; /* <<-- हा दुसरा महत्त्वाचा बदल आहे */
        }
        
        .feedback-input-container { display: none !important; }
        .feedback-print-view { 
            display: block !important; 
            white-space: pre-wrap; /* Preserve line breaks */
            word-break: break-word; /* Ensure wrapping */
        }
        
        @page {
            size: A4 landscape;
            margin: 0.5in;
        }
    }
</style>
</head>
<body>

<div class="no-print filters-container">
    <label for="reportDate">तारीख:</label>
    <input type="date" id="reportDate">
    <label for="unitFilter">युनिट:</label>
    <select id="unitFilter"><option value="All">सर्व युनिट्स</option></select>
    <button onclick="generateReport()">रिपोर्ट तयार करा</button>
    <button id="downloadPdfBtn" style="display:none;" onclick="downloadPDF()">PDF डाउनलोड करा</button>
</div>

<div id="loader">डेटा लोड होत आहे, कृपया थांबा...</div>
<div id="report-content" class="report-container" style="display:none;"></div>

<script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwQ2nItJWbioX_YHFqYc50z6p2sV-BZlmwsUplvGtJSEPHs5GkLwJWaJjcfPmtIVZ8/exec";
    const API_KEY = "AIzaSyCib9D8dkRRV7MyGDfTcCqaubl19RnCdhQ";
    const SPREADSHEET_ID = "1CW1mC206dts-42HOM81X6xVwhtwz70gjD9kyzT0Pwc8";
    
    const LOG_SHEET_NAME = "CallLogs";
    const MASTER_DATA_SHEET_NAME = "MasterData";
    const UPDATE_SHEET_NAME = "Updates";

    let allCallData = [];

    document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('reportDate').value = new Date().toISOString().slice(0, 10);
        fetchInitialData();
    });

    async function fetchInitialData() {
        document.getElementById('loader').innerText = 'डेटा लोड होत आहे, कृपया थांबा...';
        try {
            const ranges = [`${LOG_SHEET_NAME}!A:I`, `${MASTER_DATA_SHEET_NAME}!A:K`, `${UPDATE_SHEET_NAME}!A:C`];
            const response = await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values:batchGet?ranges=${ranges.join('&ranges=')}&key=${API_KEY}`);
            if (!response.ok) throw new Error(`Google Sheets API error: ${response.status}`);
            const data = await response.json();
            
            const [callLogResponse, masterDataResponse, updatesResponse] = data.valueRanges;
            const callLogRows = callLogResponse.values || [];
            const masterDataRows = masterDataResponse.values || [];
            const updatesRows = updatesResponse.values || [];
            
            const masterHeaders = masterDataRows.shift() || [];
            const loanNoIndex_master = masterHeaders.indexOf("लोन नंबर");
            const unitIndex_master = masterHeaders.indexOf("युनिट नांव");
            const caNameIndex_master = masterHeaders.indexOf("सी ऐ चे नांव");
            const loanDetailsLookup = new Map();
            const uniqueUnits = new Set();
            masterDataRows.forEach(row => {
                const loanNo = row[loanNoIndex_master];
                if (!loanNo) return;
                const unit = row[unitIndex_master] || 'अज्ञात';
                const caName = row[caNameIndex_master] || 'उपलब्ध नाही';
                loanDetailsLookup.set(String(loanNo).trim(), { unit, caName });
                if (unit !== 'अज्ञात') uniqueUnits.add(unit);
            });
            populateUnitFilter(uniqueUnits);

            const remarksLookup = new Map();
            if (updatesRows.length > 0) {
                const updateHeaders = updatesRows.shift() || [];
                const dateIndex_update = updateHeaders.indexOf("Date");
                const loanNoIndex_update = updateHeaders.indexOf("Loan Number");
                const remarkIndex_update = updateHeaders.indexOf("Remark");
                updatesRows.forEach(row => {
                    const date = row[dateIndex_update];
                    const loanNo = row[loanNoIndex_update];
                    const remark = row[remarkIndex_update] || '';
                    if (date && loanNo) {
                        const key = `${date}_${String(loanNo).trim()}`;
                        remarksLookup.set(key, remark);
                    }
                });
            }
            
            if (callLogRows.length > 1) {
                const callLogHeaders = callLogRows.shift() || [];
                const dateIndex = callLogHeaders.indexOf("Date");
                const loanNoIndex_logs = callLogHeaders.indexOf("Loan Number");
                const customerNameIndex = callLogHeaders.indexOf("Customer Name");
                const statusIndex = callLogHeaders.indexOf("Status");
                const detailsIndex = callLogHeaders.indexOf("Details");
                const paymentDateIndex = callLogHeaders.indexOf("Payment Date");
                const amountPaidToIndex = callLogHeaders.indexOf("Amount Paid To");
                allCallData = callLogRows.map(row => {
                    const callDate = String(row[dateIndex] || '').trim();
                    const loanNo = String(row[loanNoIndex_logs] || '').trim();
                    const details = loanDetailsLookup.get(loanNo) || { unit: 'अज्ञात', caName: 'उपलब्ध नाही' };
                    const remarkKey = `${callDate}_${loanNo}`;
                    const fieldRemark = remarksLookup.get(remarkKey) || '';
                    return {
                        date: callDate, loanNo: loanNo, customerName: row[customerNameIndex] || 'अज्ञात',
                        status: row[statusIndex] || 'इतर', details: row[detailsIndex] || '',
                        paymentDate: row[paymentDateIndex] || '', amountPaidTo: row[amountPaidToIndex] || '',
                        unit: details.unit, caName: details.caName, fieldRemark: fieldRemark
                    };
                }).filter(row => row.date);
            }
            document.getElementById('loader').innerText = 'डेटा लोड झाला आहे. कृपया रिपोर्ट तयार करण्यासाठी पर्याय निवडा.';
        } catch (error) {
            console.error("Error fetching data:", error);
            document.getElementById('loader').innerText = "त्रुटी: डेटा लोड होऊ शकला नाही.";
            alert("डेटा लोड करण्यात अयशस्वी: " + error.message);
        }
    }

    function populateUnitFilter(units) {
        const unitFilter = document.getElementById('unitFilter');
        Array.from(units).sort().forEach(unit => {
            const option = document.createElement('option');
            option.value = unit; option.textContent = unit;
            unitFilter.appendChild(option);
        });
    }

    function generateReport() {
        const selectedDate = document.getElementById('reportDate').value;
        const selectedUnit = document.getElementById('unitFilter').value;
        if (!selectedDate) { alert("कृपया तारीख निवडा."); return; }
        const reportData = allCallData.filter(row => row.date === selectedDate && (selectedUnit === 'All' || row.unit === selectedUnit));
        const reportContainer = document.getElementById('report-content');
        if (reportData.length === 0) {
            reportContainer.innerHTML = `<div class="empty-message">दिनांक ${selectedDate} रोजी '${selectedUnit}' साठी कोणताही डेटा उपलब्ध नाही.</div>`;
            reportContainer.style.display = 'block';
            document.getElementById('downloadPdfBtn').style.display = 'none';
            return;
        }
        document.getElementById('loader').style.display = 'none';
        reportContainer.style.display = 'block';
        document.getElementById('downloadPdfBtn').style.display = 'inline-block';
        
        const ptp = reportData.filter(r => r.status.includes('पेमेंटची तारीख'));
        const paidToStaff = reportData.filter(r => r.status.includes('हप्ता'));
        const notPicked = reportData.filter(r => r.status === 'कॉल घेतला नाही');
        const wrongNo = reportData.filter(r => r.status === 'चुकीचा मोबाईल नंबर');
        const others = reportData.filter(r => !ptp.includes(r) && !paidToStaff.includes(r) && !notPicked.includes(r) && !wrongNo.includes(r));
        
        let html = `<div class="report-header"><h1>दैनिक कॉलिंग परफॉर्मन्स रिपोर्ट</h1><p><strong>युनिट:</strong> ${selectedUnit} | <strong>तारीख:</strong> ${new Date(selectedDate).toLocaleDateString('mr-IN', { timeZone: 'UTC' })}</p></div>`;
        
        html += createDetailTable('पेमेंटची तारीख निश्चित (PTP)', ['ग्राहक', 'लोन नंबर', 'सीएचे नाव', 'पेमेंटची तारीख', 'अभिप्राय'], ptp, (item) => `<td>${item.customerName}</td><td>${item.loanNo}</td><td>${item.caName}</td><td>${item.paymentDate || '-'}</td>${createFeedbackCell(item)}`);
        html += createDetailTable('हप्ता स्टाफकडे भरला', ['ग्राहक', 'लोन नंबर', 'सीएचे नाव', 'तपशील', 'अभिप्राय'], paidToStaff, (item) => `<td>${item.customerName}</td><td>${item.loanNo}</td><td>${item.caName}</td><td>${item.amountPaidTo || '-'}</td>${createFeedbackCell(item)}`);
        html += createDetailTable('अनुत्पादक कॉल्स', ['ग्राहक', 'लोन नंबर', 'सीएचे नाव', 'स्थिती', 'अभिप्राय'], [...notPicked, ...wrongNo], (item) => `<td>${item.customerName}</td><td>${item.loanNo}</td><td>${item.caName}</td><td>${item.status}</td>${createFeedbackCell(item)}`);
        html += createDetailTable('इतर कॉल्स', ['ग्राहक', 'लोन नंबर', 'सीएचे नाव', 'स्थिती', 'तपशील', 'अभिप्राय'], others, (item) => `<td>${item.customerName}</td><td>${item.loanNo}</td><td>${item.caName}</td><td>${item.status}</td><td>${item.details || '-'}</td>${createFeedbackCell(item)}`);
        
        reportContainer.innerHTML = html;
        document.querySelectorAll('.feedback-cell textarea').forEach(ta => autoResize(ta));
    }
    
    function autoResize(textarea) {
        textarea.style.height = 'auto';
        textarea.style.height = (textarea.scrollHeight) + 'px';
    }

    function createFeedbackCell(item) {
        const remarkText = item.fieldRemark.replace(/</g, "&lt;").replace(/>/g, "&gt;");
        return `
            <td class="feedback-cell">
                <div class="feedback-input-container no-print">
                    <textarea id="remark-${item.loanNo}" oninput="autoResize(this)" placeholder="येथे अभिप्राय लिहा...">${remarkText}</textarea>
                    <button onclick="saveRemark('${item.date}', '${item.loanNo}')">सेव्ह</button>
                </div>
                <div class="feedback-print-view">${remarkText}</div>
            </td>`;
    }

    async function saveRemark(date, loanNumber) {
        const remarkInput = document.getElementById(`remark-${loanNumber}`);
        const remark = remarkInput.value.trim();
        const button = remarkInput.nextElementSibling;
        if (!remark) { alert("कृपया अभिप्राय लिहा."); return; }

        button.textContent = 'सेव्ह...';
        button.disabled = true;

        try {
            const response = await fetch(SCRIPT_URL, {
                method: 'POST',
                mode: 'cors',
                headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                body: JSON.stringify({ date, loanNumber, remark })
            });
            const result = await response.json();
            if (result.status === "success") {
                alert(result.message);
                remarkInput.style.backgroundColor = '#d4edda';
                const printView = remarkInput.closest('.feedback-cell').querySelector('.feedback-print-view');
                if (printView) {
                    printView.textContent = remark;
                }
            } else { throw new Error(result.message); }
        } catch (error) {
            alert("अभिप्राय सेव्ह करताना त्रुटी: " + error.message);
            remarkInput.style.backgroundColor = '#f8d7da';
        } finally {
            button.textContent = 'सेव्ह';
            button.disabled = false;
        }
    }

    function createDetailTable(title, headers, data, rowBuilder) {
        let tableHtml = `<div class="report-section"><h2>${title} (${data.length})</h2>`;
        if (data.length === 0) {
            tableHtml += `<div class="empty-message">या प्रकारात कोणताही डेटा उपलब्ध नाही.</div>`;
        } else {
            tableHtml += `<table class="detail-table">
                <thead><tr>${headers.map(h => `<th>${h}</th>`).join('')}</tr></thead>
                <tbody>${data.map(item => `<tr>${rowBuilder(item)}</tr>`).join('')}</tbody>
            </table>`;
        }
        tableHtml += `</div>`;
        return tableHtml;
    }

    function downloadPDF() {
        const element = document.getElementById('report-content');
        const unit = document.getElementById('unitFilter').value;
        const date = document.getElementById('reportDate').value;
        const filename = `Calling_Report_${unit}_${date}.pdf`;

        html2pdf().from(element).set({
            margin: 0.5,
            filename: filename,
            image: { type: 'jpeg', quality: 0.98 },
            html2canvas: { scale: 2, useCORS: true, letterRendering: true },
            jsPDF: { unit: 'in', format: 'a4', orientation: 'landscape' }
        }).save();
    }
</script>
</body>
</html>
