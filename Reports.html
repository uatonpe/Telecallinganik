<!DOCTYPE html>
<html lang="mr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>दैनिक कॉलिंग रिपोर्ट</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&family=Noto+Sans+Devanagari:wght@400;500;600;700&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<!-- !! डिझाइनमधील सर्व मोठे बदल येथे आहेत !! -->
<style>
    :root { 
        --primary-bg: #f4f7fc; 
        --card-bg: #ffffff; 
        --header-bg: #0d47a1; 
        --primary-text: #333; 
        --secondary-text: #555; 
        --border-color: #dee2e6;
        --success-color: #28a745;
        --success-hover-color: #218838;
    }
    body { font-family: 'Poppins', 'Noto Sans Devanagari', sans-serif; background-color: var(--primary-bg); margin: 0; color: var(--primary-text); }
    .no-print { background: var(--header-bg); padding: 15px 25px; color: white; display: flex; align-items: center; justify-content: center; gap: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); flex-wrap: wrap; }
    .filters-container label { font-size: 14px; margin-right: 8px; }
    .filters-container input, .filters-container select, .filters-container button { padding: 8px 12px; border-radius: 6px; border: 1px solid #ccc; font-family: inherit; font-size: 14px; }
    .filters-container button { background-color: var(--success-color); color: white; cursor: pointer; border-color: var(--success-color); }
    #downloadPdfBtn { background-color: #dc3545; color: white; cursor: pointer; border-color: #dc3545; }
    #loader { text-align: center; padding: 40px; font-size: 18px; color: var(--secondary-text); }
    .report-container { max-width: 90%; margin: 30px auto; background: var(--card-bg); padding: 25px 40px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08); border-radius: 8px; }
    .report-header { text-align: center; border-bottom: 2px solid var(--header-bg); padding-bottom: 15px; margin-bottom: 25px; }
    .report-section { margin-bottom: 30px; }
    .report-section h2 { font-size: 18px; font-weight: 600; color: var(--primary-text); border-bottom: 1px solid var(--border-color); padding-bottom: 8px; margin-bottom: 15px; }
    .detail-table { width: 100%; border-collapse: collapse; font-size: 14px; }
    .detail-table th, .detail-table td { border: 1px solid var(--border-color); padding: 10px; text-align: left; vertical-align: middle; }
    .detail-table th { background-color: #f2f2f2; font-weight: 600; }
    .empty-message { text-align: center; color: grey; padding: 20px; }
    
    /* अभिप्राय (Feedback) साठी नवीन आणि सुधारित स्टाईल */
    .feedback-header {
        color: var(--header-bg); /* फक्त शब्दाचा रंग निळा */
        text-align: center;
    }
    .feedback-cell { 
        display: flex; 
        align-items: center; 
        gap: 5px;
        min-width: 250px; /* रुंदी कमी होऊ नये म्हणून */
    }
    .feedback-cell input { 
        flex-grow: 1; 
        padding: 8px; 
        border: 1px solid #ccc; 
        border-radius: 4px;
        transition: border-color 0.2s, box-shadow 0.2s;
    }
    .feedback-cell input:focus {
        border-color: var(--header-bg);
        outline: none;
        box-shadow: 0 0 0 2px rgba(13, 71, 161, 0.2);
    }
    .feedback-cell button { 
        padding: 8px 12px; 
        font-size: 12px; 
        white-space: nowrap;
        background-color: var(--success-color);
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        transition: background-color 0.2s;
    }
    .feedback-cell button:hover {
        background-color: var(--success-hover-color);
    }
    .feedback-cell button:disabled {
        background-color: #cccccc;
        cursor: not-allowed;
    }
</style>
</head>
<body>

<div class="no-print filters-container">
    <label for="reportDate">तारीख:</label>
    <input type="date" id="reportDate">
    <label for="unitFilter">युनिट:</label>
    <select id="unitFilter"><option value="All">सर्व युनिट्स</option></select>
    <button onclick="generateReport()">रिपोर्ट तयार करा</button>
    <button id="downloadPdfBtn" style="display:none;" onclick="downloadPDF()">PDF डाउनलोड करा</button>
</div>

<div id="loader">डेटा लोड होत आहे, कृपया थांबा...</div>
<div id="report-content" class="report-container" style="display:none;"></div>

<script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwQ2nItJWbioX_YHFqYc50z6p2sV-BZlmwsUplvGtJSEPHs5GkLwJWaJjcfPmtIVZ8/exec"; // ही URL बदलू नका
    const API_KEY = "AIzaSyCib9D8dkRRV7MyGDfTcCqaubl19RnCdhQ";
    const SPREADSHEET_ID = "1CW1mC206dts-42HOM81X6xVwhtwz70gjD9kyzT0Pwc8";
    
    const LOG_SHEET_NAME = "CallLogs";
    const MASTER_DATA_SHEET_NAME = "MasterData";
    const UPDATE_SHEET_NAME = "Updates";

    let allCallData = [];

    document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('reportDate').value = new Date().toISOString().slice(0, 10);
        fetchInitialData();
    });

    // JavaScript मध्ये कोणताही मोठा बदल नाही, तो पूर्वीप्रमाणेच काम करतो.
    async function fetchInitialData() {
        document.getElementById('loader').innerText = 'डेटा लोड होत आहे, कृपया थांबा...';
        try {
            const ranges = [`${LOG_SHEET_NAME}!A:I`, `${MASTER_DATA_SHEET_NAME}!A:K`, `${UPDATE_SHEET_NAME}!A:C`];
            const response = await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values:batchGet?ranges=${ranges.join('&ranges=')}&key=${API_KEY}`);
            if (!response.ok) throw new Error(`Google Sheets API error: ${response.status}`);
            const data = await response.json();
            
            const [callLogResponse, masterDataResponse, updatesResponse] = data.valueRanges;
            const callLogRows = callLogResponse.values || [];
            const masterDataRows = masterDataResponse.values || [];
            const updatesRows = updatesResponse.values || [];
            
            const masterHeaders = masterDataRows.shift() || [];
            const loanNoIndex_master = masterHeaders.indexOf("लोन नंबर");
            const unitIndex_master = masterHeaders.indexOf("युनिट नांव");
            const caNameIndex_master = masterHeaders.indexOf("सी ऐ चे नांव");
            const loanDetailsLookup = new Map();
            const uniqueUnits = new Set();
            masterDataRows.forEach(row => {
                const loanNo = row[loanNoIndex_master];
                if (!loanNo) return;
                const unit = row[unitIndex_master] || 'अज्ञात';
                const caName = row[caNameIndex_master] || 'उपलब्ध नाही';
                loanDetailsLookup.set(String(loanNo).trim(), { unit, caName });
                if (unit !== 'अज्ञात') uniqueUnits.add(unit);
            });
            populateUnitFilter(uniqueUnits);

            const remarksLookup = new Map();
            if (updatesRows.length > 0) {
                const updateHeaders = updatesRows.shift() || [];
                const dateIndex_update = updateHeaders.indexOf("Date");
                const loanNoIndex_update = updateHeaders.indexOf("Loan Number");
                const remarkIndex_update = updateHeaders.indexOf("Remark");
                updatesRows.forEach(row => {
                    const date = row[dateIndex_update];
                    const loanNo = row[loanNoIndex_update];
                    const remark = row[remarkIndex_update] || '';
                    if (date && loanNo) {
                        const key = `${date}_${String(loanNo).trim()}`;
                        remarksLookup.set(key, remark);
                    }
                });
            }
            
            if (callLogRows.length > 1) {
                const callLogHeaders = callLogRows.shift() || [];
                const dateIndex = callLogHeaders.indexOf("Date");
                const loanNoIndex_logs = callLogHeaders.indexOf("Loan Number");
                const customerNameIndex = callLogHeaders.indexOf("Customer Name");
                const statusIndex = callLogHeaders.indexOf("Status");
                const detailsIndex = callLogHeaders.indexOf("Details");
                const paymentDateIndex = callLogHeaders.indexOf("Payment Date");
                const amountPaidToIndex = callLogHeaders.indexOf("Amount Paid To");
                allCallData = callLogRows.map(row => {
                    const callDate = String(row[dateIndex] || '').trim();
                    const loanNo = String(row[loanNoIndex_logs] || '').trim();
                    const details = loanDetailsLookup.get(loanNo) || { unit: 'अज्ञात', caName: 'उपलब्ध नाही' };
                    const remarkKey = `${callDate}_${loanNo}`;
                    const fieldRemark = remarksLookup.get(remarkKey) || '';
                    return {
                        date: callDate, loanNo: loanNo, customerName: row[customerNameIndex] || 'अज्ञात',
                        status: row[statusIndex] || 'इतर', details: row[detailsIndex] || '',
                        paymentDate: row[paymentDateIndex] || '', amountPaidTo: row[amountPaidToIndex] || '',
                        unit: details.unit, caName: details.caName, fieldRemark: fieldRemark
                    };
                }).filter(row => row.date);
            }
            document.getElementById('loader').innerText = 'डेटा लोड झाला आहे. कृपया रिपोर्ट तयार करण्यासाठी पर्याय निवडा.';
        } catch (error) {
            console.error("Error fetching data:", error);
            document.getElementById('loader').innerText = "त्रुटी: डेटा लोड होऊ शकला नाही.";
            alert("डेटा लोड करण्यात अयशस्वी: " + error.message);
        }
    }

    function populateUnitFilter(units) {
        const unitFilter = document.getElementById('unitFilter');
        Array.from(units).sort().forEach(unit => {
            const option = document.createElement('option');
            option.value = unit; option.textContent = unit;
            unitFilter.appendChild(option);
        });
    }

    function generateReport() {
        const selectedDate = document.getElementById('reportDate').value;
        const selectedUnit = document.getElementById('unitFilter').value;
        if (!selectedDate) { alert("कृपया तारीख निवडा."); return; }
        const reportData = allCallData.filter(row => row.date === selectedDate && (selectedUnit === 'All' || row.unit === selectedUnit));
        const reportContainer = document.getElementById('report-content');
        if (reportData.length === 0) {
            reportContainer.innerHTML = `<div class="empty-message">दिनांक ${selectedDate} रोजी '${selectedUnit}' साठी कोणताही डेटा उपलब्ध नाही.</div>`;
            reportContainer.style.display = 'block';
            document.getElementById('downloadPdfBtn').style.display = 'none';
            return;
        }
        document.getElementById('loader').style.display = 'none';
        reportContainer.style.display = 'block';
        document.getElementById('downloadPdfBtn').style.display = 'inline-block';
        
        const ptp = reportData.filter(r => r.status.includes('पेमेंटची तारीख'));
        const paidToStaff = reportData.filter(r => r.status.includes('हप्ता'));
        const notPicked = reportData.filter(r => r.status === 'कॉल घेतला नाही');
        const wrongNo = reportData.filter(r => r.status === 'चुकीचा मोबाईल नंबर');
        const others = reportData.filter(r => !ptp.includes(r) && !paidToStaff.includes(r) && !notPicked.includes(r) && !wrongNo.includes(r));
        
        let html = `<div class="report-header"><h1>दैनिक कॉलिंग परफॉर्मन्स रिपोर्ट</h1><p><strong>युनिट:</strong> ${selectedUnit} | <strong>तारीख:</strong> ${new Date(selectedDate).toLocaleDateString('mr-IN', { timeZone: 'UTC' })}</p></div>`;
        
        html += createDetailTable('पेमेंटची तारीख निश्चित (PTP)', ['ग्राहक', 'लोन नंबर', 'सीएचे नाव', 'पेमेंटची तारीख', 'अभिप्राय'], ptp, (item) => `<td>${item.customerName}</td><td>${item.loanNo}</td><td>${item.caName}</td><td>${item.paymentDate || '-'}</td>${createFeedbackCell(item)}`);
        html += createDetailTable('हप्ता स्टाफकडे भरला', ['ग्राहक', 'लोन नंबर', 'सीएचे नाव', 'तपशील', 'अभिप्राय'], paidToStaff, (item) => `<td>${item.customerName}</td><td>${item.loanNo}</td><td>${item.caName}</td><td>${item.amountPaidTo || '-'}</td>${createFeedbackCell(item)}`);
        html += createDetailTable('अनुत्पादक कॉल्स', ['ग्राहक', 'लोन नंबर', 'सीएचे नाव', 'स्थिती', 'अभिप्राय'], [...notPicked, ...wrongNo], (item) => `<td>${item.customerName}</td><td>${item.loanNo}</td><td>${item.caName}</td><td>${item.status}</td>${createFeedbackCell(item)}`);
        html += createDetailTable('इतर कॉल्स', ['ग्राहक', 'लोन नंबर', 'सीएचे नाव', 'स्थिती', 'तपशील', 'अभिप्राय'], others, (item) => `<td>${item.customerName}</td><td>${item.loanNo}</td><td>${item.caName}</td><td>${item.status}</td><td>${item.details || '-'}</td>${createFeedbackCell(item)}`);
        
        reportContainer.innerHTML = html;
    }
    
    function createFeedbackCell(item) {
        return `
            <td class="feedback-cell no-print">
                <input type="text" id="remark-${item.loanNo}" value="${item.fieldRemark}" placeholder="येथे अभिप्राय लिहा...">
                <button onclick="saveRemark('${item.date}', '${item.loanNo}')">सेव्ह</button>
            </td>`;
    }

    async function saveRemark(date, loanNumber) {
        const remarkInput = document.getElementById(`remark-${loanNumber}`);
        const remark = remarkInput.value.trim();
        const button = remarkInput.nextElementSibling;
        if (!remark) { alert("कृपया अभिप्राय लिहा."); return; }

        button.textContent = 'सेव्ह...';
        button.disabled = true;

        try {
            const response = await fetch(SCRIPT_URL, {
                method: 'POST',
                mode: 'cors',
                headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                body: JSON.stringify({ date, loanNumber, remark })
            });
            const result = await response.json();
            if (result.status === "success") {
                alert(result.message);
                remarkInput.style.backgroundColor = '#d4edda';
            } else { throw new Error(result.message); }
        } catch (error) {
            alert("अभिप्राय सेव्ह करताना त्रुटी: " + error.message);
            remarkInput.style.backgroundColor = '#f8d7da';
        } finally {
            button.textContent = 'सेव्ह';
            button.disabled = false;
        }
    }

    function createDetailTable(title, headers, data, rowBuilder) {
        headers[headers.length - 1] = `<span class="feedback-header no-print">${headers[headers.length - 1]}</span>`;

        let tableHtml = `<div class="report-section"><h2>${title} (${data.length})</h2>`;
        if (data.length === 0) {
            tableHtml += `<div class="empty-message">या प्रकारात कोणताही डेटा उपलब्ध नाही.</div>`;
        } else {
            tableHtml += `<table class="detail-table"><thead><tr><th>${headers.join('</th><th>')}</th></tr></thead><tbody>${data.map(item => `<tr>${rowBuilder(item)}</tr>`).join('')}</tbody></table>`;
        }
        tableHtml += `</div>`;
        return tableHtml;
    }

    function downloadPDF() {
        const element = document.getElementById('report-content');
        html2pdf().from(element).set({
            margin: 0.5,
            filename: `Calling_Report_${document.getElementById('unitFilter').value}_${document.getElementById('reportDate').value}.pdf`,
            image: { type: 'jpeg', quality: 0.98 },
            html2canvas: { scale: 2, useCORS: true },
            jsPDF: { unit: 'in', format: 'a4', orientation: 'landscape' }
        }).save();
    }
</script>
</body>
</html>
